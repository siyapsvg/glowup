<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GlowUp">
<meta name="theme-color" content="#0d0d0f">
<title>GlowUp</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ‚îÄ‚îÄ RESET & BASE ‚îÄ‚îÄ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{background:#0d0d0f;color:#e8e8f0;font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 700px 500px at 0% 0%,rgba(200,245,100,.05),transparent 60%),radial-gradient(ellipse 600px 400px at 100% 100%,rgba(100,200,245,.04),transparent 60%)}
input,textarea,select,button{font-family:'DM Sans',sans-serif}
textarea{resize:none}
input[type=range]{accent-color:#c8f564}
input[type=time]{color-scheme:dark}
::-webkit-scrollbar{display:none}
scrollbar-width:none;

/* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
.serif{font-family:'Playfair Display',serif}
.mono{font-family:'DM Mono',monospace}

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes popIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
.fade-up{animation:fadeUp .3s ease both}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app{position:relative;z-index:1;min-height:100vh}
.page{display:none;padding-bottom:92px;animation:fadeUp .3s ease both}
.page.active{display:block}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
#nav{position:fixed;bottom:0;left:0;right:0;background:rgba(13,13,15,.97);backdrop-filter:blur(24px);border-top:1px solid #262636;display:flex;z-index:200;padding-bottom:env(safe-area-inset-bottom,0)}
.nav-btn{flex:1;padding:10px 2px 8px;display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;color:#50506a;cursor:pointer;transition:color .2s;font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.3px;text-transform:uppercase}
.nav-btn .ico{font-size:17px;line-height:1}
.nav-btn.active{color:#c8f564}
.nav-dot{width:4px;height:4px;border-radius:50%;background:transparent}
.nav-btn.active .nav-dot{background:#c8f564}

/* ‚îÄ‚îÄ CARDS & COMMON ‚îÄ‚îÄ */
.card{background:#14141a;border:1px solid #262636;border-radius:14px}
.card-lime{border-color:#c8f564}
.ph{padding:48px 18px 18px}
.sec-lbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;padding:0 18px 10px;display:block}
.divider{height:1px;background:#262636;margin:0 14px}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn-lime{background:#c8f564;color:#0d0d0f;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-weight:700;cursor:pointer;transition:opacity .15s}
.btn-lime:active{opacity:.85}
.btn-ghost{background:none;border:1px solid #32324a;border-radius:12px;color:#8888a8;font-size:14px;font-weight:600;cursor:pointer;padding:13px;width:100%;text-align:center;transition:border-color .2s}
.btn-ghost:hover{border-color:#f56464;color:#f56464}
.btn-save{display:block;width:100%;padding:13px;border:none;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;text-align:center;margin-bottom:20px}

/* ‚îÄ‚îÄ PROGRESS RING ‚îÄ‚îÄ */
.ring-wrap{position:relative;width:68px;height:68px;flex-shrink:0}
.ring-wrap svg{transform:rotate(-90deg)}
.ring-track{fill:none;stroke:#20202d;stroke-width:7}
.ring-fill{fill:none;stroke:url(#ringGrad);stroke-width:7;stroke-linecap:round;stroke-dasharray:188.4;stroke-dashoffset:188.4;transition:stroke-dashoffset .7s cubic-bezier(.34,1.56,.64,1)}
.ring-pct{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:13px;font-weight:500;color:#c8f564}

/* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
.tog-wrap{position:relative;width:44px;height:26px;flex-shrink:0;cursor:pointer;display:inline-block}
.tog-wrap input{opacity:0;width:0;height:0;position:absolute}
.tog-track{position:absolute;inset:0;background:#32324a;border-radius:13px;transition:background .2s}
.tog-wrap input:checked+.tog-track{background:#c8f564}
.tog-thumb{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.3);transition:left .2s;pointer-events:none}
.tog-wrap input:checked~.tog-thumb{left:21px}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:96px;left:50%;transform:translateX(-50%) translateY(16px);background:#1a1a24;border:1px solid #32324a;border-radius:20px;padding:9px 18px;font-family:'DM Mono',monospace;font-size:11px;color:#e8e8f0;white-space:nowrap;opacity:0;transition:all .3s;z-index:500;pointer-events:none}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ‚îÄ‚îÄ OVERLAY / SHEET ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:300;opacity:0;pointer-events:none;transition:opacity .25s;display:flex;align-items:flex-end}
.overlay.open{opacity:1;pointer-events:all}
.sheet{background:#14141a;border:1px solid #262636;border-radius:20px 20px 0 0;padding:20px 20px calc(24px + env(safe-area-inset-bottom,0));width:100%;transform:translateY(60px);transition:transform .3s cubic-bezier(.34,1.56,.64,1)}
.overlay.open .sheet{transform:translateY(0)}
.sheet-handle{width:36px;height:4px;background:#32324a;border-radius:2px;margin:0 auto 18px}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#loginScreen{position:fixed;inset:0;background:#0d0d0f;z-index:600;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;animation:popIn .4s ease}
.login-card{width:100%;max-width:360px;background:#14141a;border:1px solid #262636;border-radius:20px;padding:28px;position:relative;overflow:hidden}
.login-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#c8f564,#64c8f5,#f564a9)}
.login-toggle{display:flex;background:#1a1a24;border-radius:10px;padding:3px;margin-bottom:24px;gap:3px}
.lt-btn{flex:1;padding:8px;background:none;border:none;border-radius:8px;color:#50506a;font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all .2s}
.lt-btn.active{background:#32324a;color:#c8f564}
.field-lbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:6px}
.field-inp{width:100%;background:#1a1a24;border:1px solid #262636;border-radius:10px;padding:12px 14px;color:#e8e8f0;font-size:15px;outline:none;transition:border-color .2s;margin-bottom:14px}
.field-inp:focus{border-color:#c8f564}

/* ‚îÄ‚îÄ CAT SECTION ‚îÄ‚îÄ */
.cat-wrap{padding:0 14px;margin-bottom:12px}
.cat-hd{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#14141a;border:1px solid #262636;border-radius:14px;cursor:pointer;transition:border-color .2s;position:relative}
.cat-hd.open{border-radius:14px 14px 0 0;border-color:#c8f564;border-bottom-color:#262636}
.cat-ic{font-size:20px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#1a1a24;border-radius:10px;flex-shrink:0;cursor:pointer;border:1px solid #262636}
.cat-name-inp{background:transparent;border:none;border-bottom:1px solid transparent;outline:none;color:#e8e8f0;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;width:100%;cursor:pointer;transition:border-color .2s}
.cat-name-inp:focus{cursor:text;border-bottom-color:#c8f564}
.cat-pg{font-family:'DM Mono',monospace;font-size:9px;color:#50506a;margin-top:2px}
.minibar{display:flex;align-items:center;gap:6px;margin-top:5px}
.minibar-track{flex:1;height:3px;background:#20202d;border-radius:10px;overflow:hidden}
.minibar-fill{height:100%;background:#c8f564;border-radius:10px;transition:width .4s}
.minibar-pct{font-family:'DM Mono',monospace;font-size:9px;color:#c8f564;min-width:26px;text-align:right}
.cat-ch{font-size:11px;color:#50506a;transition:transform .25s;flex-shrink:0}
.cat-hd.open .cat-ch{transform:rotate(180deg)}
.cat-del{background:none;border:none;color:#50506a;cursor:pointer;font-size:13px;padding:4px;opacity:.5;flex-shrink:0}
.sub-list{background:#14141a;border:1px solid #c8f564;border-top:none;border-radius:0 0 14px 14px;overflow:hidden;display:none}
.sub-list.open{display:block}
.sub-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #262636;transition:background .15s}
.sub-item:last-of-type{border-bottom:none}
.sub-item.done{background:rgba(200,245,100,.03)}
.sub-ck{width:22px;height:22px;border-radius:50%;border:2px solid #32324a;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;transition:all .2s cubic-bezier(.34,1.56,.64,1);font-size:11px;color:transparent;background:transparent}
.sub-item.done .sub-ck{background:#c8f564;border-color:#c8f564;color:#0d0d0f}
.sub-name-inp{background:transparent;border:none;border-bottom:1px solid transparent;outline:none;color:#e8e8f0;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;width:100%;transition:all .2s}
.sub-item.done .sub-name-inp{color:#50506a;text-decoration:line-through;text-decoration-color:rgba(200,245,100,.4)}
.sub-name-inp:focus{border-bottom-color:#64c8f5}
.sub-streak{font-family:'DM Mono',monospace;font-size:9px;color:#f5c842}
.rem-tag{font-family:'DM Mono',monospace;font-size:9px;padding:2px 6px;border-radius:5px;border:1px solid rgba(100,200,245,.2);color:#64c8f5;background:rgba(100,200,245,.05);cursor:pointer;white-space:nowrap}
.sub-del{background:none;border:none;color:#50506a;cursor:pointer;font-size:12px;opacity:.4;flex-shrink:0}
.add-sub-row{display:flex;gap:8px;padding:9px 14px;border-top:1px dashed #262636}
.add-sub-inp{flex:1;background:transparent;border:none;outline:none;color:#e8e8f0;font-size:13px}
.add-sub-inp::placeholder,.field-inp::placeholder{color:#50506a}

/* ‚îÄ‚îÄ WEEKLY ‚îÄ‚îÄ */
.week-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;padding:0 14px 20px}
.wd{border-radius:10px;border:1px solid #262636;background:#14141a;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:8px 3px;text-align:center}
.wd.today{border-color:#64c8f5;color:#64c8f5}
.wd.past{background:rgba(200,245,100,.07);border-color:#c8f564}
.ws-block{margin-bottom:14px}
.ws-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#14141a;border:1px solid #262636;border-radius:12px;cursor:pointer;transition:border-color .2s;font-size:14px;font-weight:600}
.ws-block.open .ws-hd{border-radius:12px 12px 0 0;border-color:#c8f564;border-bottom-color:#262636}
.ws-body{background:#14141a;border:1px solid #c8f564;border-top:none;border-radius:0 0 12px 12px;padding:14px;display:none}
.ws-block.open .ws-body{display:block}
.plan-item{display:flex;align-items:flex-start;gap:10px;padding:7px 0;border-bottom:1px solid #262636}
.plan-item:last-of-type{border-bottom:none}
.pcb{width:18px;height:18px;border-radius:5px;border:2px solid #32324a;flex-shrink:0;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:10px;color:transparent;margin-top:1px;background:transparent}
.plan-item.chk .pcb{background:#c8f564;border-color:#c8f564;color:#0d0d0f}
.plan-item.chk .pt{color:#50506a;text-decoration:line-through}
.pt{font-size:13px;flex:1;line-height:1.5}
.ref-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#c8f564;text-transform:uppercase;display:block;margin-bottom:6px;margin-top:12px}
.ref-lbl:first-child{margin-top:0}
.ref-ta{width:100%;background:#1a1a24;border:1px solid #262636;border-radius:10px;padding:11px;color:#e8e8f0;font-family:'Playfair Display',serif;font-size:14px;font-style:italic;line-height:1.6;height:80px;outline:none;transition:border-color .2s}
.ref-ta:focus{border-color:#c8f564}
.ref-ta::placeholder{color:#50506a;font-style:italic}

/* ‚îÄ‚îÄ MIND / HUB ‚îÄ‚îÄ */
.hub-tabs{display:flex;gap:6px;padding:0 14px 16px;overflow-x:auto;white-space:nowrap}
.hub-tab{flex-shrink:0;padding:7px 14px;background:#14141a;border:1px solid #262636;border-radius:20px;font-family:'DM Mono',monospace;font-size:11px;color:#50506a;cursor:pointer;transition:all .2s;text-transform:capitalize}
.hub-tab.active{border-color:#f564a9;color:#f564a9;background:rgba(245,100,169,.07)}
.hub-panel{display:none;padding:0 14px}
.hub-panel.active{display:block}
.prompt-chips{display:flex;gap:6px;margin-bottom:14px;overflow-x:auto;padding-bottom:2px}
.p-chip{flex-shrink:0;padding:6px 12px;background:#14141a;border:1px solid #262636;border-radius:16px;font-size:11px;color:#8888a8;cursor:pointer;transition:all .2s;white-space:nowrap}
.p-chip.active{border-color:#f564a9;color:#f564a9;background:rgba(245,100,169,.06)}
.j-ta{width:100%;background:#14141a;border:1px solid #262636;border-radius:14px;padding:14px;color:#e8e8f0;font-family:'Playfair Display',serif;font-size:16px;font-style:italic;line-height:1.7;height:140px;outline:none;margin-bottom:10px;transition:border-color .2s}
.j-ta:focus{border-color:#f564a9}
.j-ta::placeholder{color:#50506a;font-style:italic}
.entry-card{background:#14141a;border:1px solid #262636;border-left:3px solid #f564a9;border-radius:12px;padding:13px;margin-bottom:10px}
.id-card{background:#14141a;border:1px solid #c8f564;border-radius:14px;padding:16px;margin-bottom:14px;position:relative;overflow:hidden}
.id-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#c8f564,#64c8f5,#f564a9)}
.id-ta{width:100%;background:transparent;border:none;outline:none;color:#e8e8f0;font-family:'Playfair Display',serif;font-size:17px;font-style:italic;line-height:1.5}
.id-ta::placeholder{color:#50506a}
.pillars-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.pillar-card{background:#14141a;border:1px solid #262636;border-radius:12px;padding:12px}
.pillar-ta{width:100%;background:transparent;border:none;outline:none;color:#e8e8f0;font-family:'DM Sans',sans-serif;font-size:12px;line-height:1.5}
.pillar-ta::placeholder{color:#50506a;font-size:11px}
.goal-card{background:#14141a;border:1px solid #262636;border-radius:12px;padding:14px;margin-bottom:10px}
.g-badge{font-family:'DM Mono',monospace;font-size:9px;padding:3px 8px;border-radius:10px;letter-spacing:1px;text-transform:uppercase;flex-shrink:0}
.gs{background:rgba(100,200,245,.1);color:#64c8f5;border:1px solid rgba(100,200,245,.2)}
.gl{background:rgba(160,100,245,.1);color:#a064f5;border:1px solid rgba(160,100,245,.2)}
.g-title-inp{background:transparent;border:none;outline:none;color:#e8e8f0;font-size:14px;font-weight:600;flex:1;font-family:'DM Sans',sans-serif}
.g-why-inp{width:100%;background:transparent;border:none;outline:none;color:#8888a8;font-family:'DM Mono',monospace;font-size:11px;margin-bottom:8px}
.g-pb{height:4px;background:#20202d;border-radius:10px;overflow:hidden}
.g-pf{height:100%;border-radius:10px;background:linear-gradient(90deg,#c8f564,#64c8f5);transition:width .4s}
.str-card{background:#14141a;border:1px solid #262636;border-left:3px solid #f5c842;border-radius:12px;padding:13px;margin-bottom:10px}
.str-inp{width:100%;background:#14141a;border:1px solid #262636;border-radius:12px;padding:11px;color:#e8e8f0;font-size:13px;height:70px;margin-bottom:8px;outline:none;transition:border-color .2s}
.str-inp:focus{border-color:#f5c842}
.str-inp::placeholder{color:#50506a}
.str-rf-inp{width:100%;background:#14141a;border:1px solid #262636;border-radius:12px;padding:11px;color:#f5c842;font-family:'Playfair Display',serif;font-size:13px;font-style:italic;height:60px;margin-bottom:8px;outline:none;transition:border-color .2s}
.str-rf-inp:focus{border-color:#f5c842}
.str-rf-inp::placeholder{color:#50506a;font-style:italic}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.period-tabs{display:flex;gap:6px;padding:0 14px 20px}
.ppt{padding:7px 14px;background:#14141a;border:1px solid #262636;border-radius:20px;font-family:'DM Mono',monospace;font-size:11px;color:#50506a;cursor:pointer;transition:all .2s}
.ppt.active{border-color:#64f5b8;color:#64f5b8;background:rgba(100,245,184,.06)}
.prog-overview{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 14px;margin-bottom:20px}
.po-card{background:#14141a;border:1px solid #262636;border-radius:14px;padding:14px}
.heatmap{display:flex;flex-wrap:wrap;gap:3px}
.hm-cell{border-radius:3px;background:#20202d;transition:background .2s}
.hm-cell.l1{background:rgba(200,245,100,.2)}
.hm-cell.l2{background:rgba(200,245,100,.45)}
.hm-cell.l3{background:rgba(200,245,100,.7)}
.hm-cell.l4{background:#c8f564}
.cp-card{background:#14141a;border:1px solid #262636;border-radius:14px;padding:14px;margin-bottom:10px}

/* ‚îÄ‚îÄ FRIENDS ‚îÄ‚îÄ */
.share-card{margin:0 14px 20px;background:#14141a;border:1px solid #32324a;border-radius:16px;padding:18px;position:relative;overflow:hidden}
.share-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#f5c842,#f564a9)}
.code-box{background:#0d0d0f;border:1px solid #262636;border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px;margin-bottom:10px}
.lb-card{background:#14141a;border:1px solid #262636;border-radius:14px;overflow:hidden}
.lb-row{display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid #262636}
.lb-row:last-child{border-bottom:none}
.lb-row.you{background:rgba(200,245,100,.03)}

/* ‚îÄ‚îÄ ME PAGE ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 14px;margin-bottom:20px}
.stat-card{background:#14141a;border:1px solid #262636;border-radius:12px;padding:12px;text-align:center}
.id-snap{background:#14141a;border:1px solid #262636;border-radius:14px;padding:16px;position:relative;overflow:hidden}
.id-snap::after{content:'I AM';position:absolute;right:10px;top:6px;font-family:'Playfair Display',serif;font-size:56px;font-weight:900;color:rgba(200,245,100,.04);line-height:1;pointer-events:none}

/* ‚îÄ‚îÄ EMOJI PICKER ‚îÄ‚îÄ */
.em-grid{display:flex;flex-wrap:wrap;gap:6px}
.em-btn{font-size:24px;width:44px;height:44px;border-radius:10px;background:#1a1a24;border:none;cursor:pointer}
.em-btn:active{background:#20202d}

/* ‚îÄ‚îÄ SETTINGS ROW ‚îÄ‚îÄ */
.s-row{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid #262636}
.s-row:last-child{border-bottom:none}
.tin{background:#1a1a24;border:1px solid #262636;border-radius:8px;padding:5px 10px;color:#e8e8f0;font-family:'DM Mono',monospace;font-size:12px;outline:none}

/* ‚îÄ‚îÄ SCHEDULE ‚îÄ‚îÄ */
.sched-block{position:absolute;left:64px;right:6px;border-radius:8px;padding:5px 8px;font-size:11px;font-weight:600;cursor:pointer;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.3);transition:opacity .15s}
.sched-block:active{opacity:.8}
.sched-hour{position:absolute;left:0;width:56px;text-align:right;font-family:'DM Mono',monospace;font-size:10px;color:#50506a;padding-right:8px;user-select:none}
.sched-line{position:absolute;left:64px;right:0;height:1px;background:#1a1a24}
.sched-now{position:absolute;left:0;right:0;height:2px;background:#f564a9;z-index:10}
.sched-now::before{content:'';position:absolute;left:56px;top:-4px;width:10px;height:10px;border-radius:50%;background:#f564a9}
.day-pick-btn{padding:6px 10px;background:#14141a;border:1px solid #262636;border-radius:8px;font-family:'DM Mono',monospace;font-size:11px;color:#50506a;cursor:pointer;transition:all .2s}
.day-pick-btn.active{background:rgba(200,245,100,.1);border-color:#c8f564;color:#c8f564}
.col-pick{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:border-color .2s;flex-shrink:0}
.col-pick.active{border-color:#fff}
.wk-col{flex:1;min-width:0;border-right:1px solid #1a1a24;position:relative}
.wk-col:last-child{border-right:none}
/* ‚îÄ‚îÄ ADD ROW ‚îÄ‚îÄ */
.add-row{padding:0 14px 20px;display:flex;gap:10px}
.add-inp{flex:1;background:#14141a;border:1px solid #262636;border-radius:12px;padding:11px 14px;color:#e8e8f0;font-size:14px;outline:none;transition:border-color .2s}
.add-inp:focus{border-color:#c8f564}
.add-inp::placeholder{color:#50506a}
.add-plan-row{display:flex;gap:8px;margin-top:10px}
.add-plan-inp{flex:1;background:#1a1a24;border:1px solid #262636;border-radius:8px;padding:7px 12px;color:#e8e8f0;font-size:13px;outline:none}
.add-plan-inp:focus{border-color:#c8f564}
.add-plan-inp::placeholder{color:#50506a}
</style>
</head>
<body>
<div id="toast"></div>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div id="loginScreen">
  <div style="text-align:center;margin-bottom:32px">
    <div class="serif" style="font-size:52px;font-weight:900;background:linear-gradient(135deg,#c8f564,#64c8f5);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1">GlowUp</div>
    <div class="mono" style="font-size:10px;color:#50506a;letter-spacing:3px;text-transform:uppercase;margin-top:8px">Your identity. Your progress.</div>
  </div>
  <div class="login-card">
    <div class="login-toggle">
      <button class="lt-btn active" id="ltLogin" onclick="switchAuth('login')">Sign In</button>
      <button class="lt-btn" id="ltReg" onclick="switchAuth('register')">Create Account</button>
    </div>
    <label class="field-lbl">Email Address</label>
    <input class="field-inp" id="authUser" type="email" placeholder="you@email.com" autocapitalize="none" autocomplete="email" inputmode="email">
    <label class="field-lbl">Password</label>
    <input class="field-inp" id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    <div id="displayNameField" style="display:none">
      <label class="field-lbl">Your Name <span style="color:#f564a9">*</span></label>
      <input class="field-inp" id="authDisplay" type="text" placeholder="e.g. Maya" autocomplete="name">
    </div>
    <button class="btn-lime" id="authBtn" onclick="handleAuth()" style="width:100%;padding:14px;font-size:15px;margin-top:4px">Sign In ‚Üí</button>
    <div class="mono" id="authErr" style="font-size:11px;color:#f56464;text-align:center;margin-top:10px;min-height:16px"></div>
  </div>
  <div class="mono" style="font-size:10px;color:#50506a;text-align:center;margin-top:16px;line-height:1.8">
    ‚òÅÔ∏è Syncs across all your devices.<br>
    Share your app URL with your friend to compete.
  </div>
</div>

<!-- ‚ïê‚ïê APP ‚ïê‚ïê -->
<div id="app" style="display:none">

<!-- PAGES -->
<div class="page active" id="page-today"></div>
<div class="page" id="page-weekly"></div>
<div class="page" id="page-journal"></div>
<div class="page" id="page-progress"></div>
<div class="page" id="page-schedule"></div>
<div class="page" id="page-friends"></div>
<div class="page" id="page-me"></div>

<!-- NAV -->
<nav id="nav">
  <button class="nav-btn active" data-page="today" onclick="go('today')"><span class="ico">‚ú¶</span><span>Today</span><span class="nav-dot"></span></button>
  <button class="nav-btn" data-page="schedule" onclick="go('schedule')"><span class="ico">üóì</span><span>Schedule</span><span class="nav-dot"></span></button>
  <button class="nav-btn" data-page="weekly" onclick="go('weekly')"><span class="ico">üìã</span><span>Weekly</span><span class="nav-dot"></span></button>
  <button class="nav-btn" data-page="journal" onclick="go('journal')"><span class="ico">üìì</span><span>Mind</span><span class="nav-dot"></span></button>
  <button class="nav-btn" data-page="friends" onclick="go('friends')"><span class="ico">üèÜ</span><span>Friends</span><span class="nav-dot"></span></button>
  <button class="nav-btn" data-page="me" onclick="go('me')"><span class="ico">üåü</span><span>Me</span><span class="nav-dot"></span></button>
</nav>

<!-- OVERLAYS -->
<div class="overlay" id="emojiOverlay" onclick="closeEmoji(event)">
  <div class="sheet"><div class="sheet-handle"></div>
    <div class="mono" style="font-size:10px;color:#50506a;text-transform:uppercase;letter-spacing:1px;text-align:center;margin-bottom:12px">Choose Emoji</div>
    <div class="em-grid" id="emojiGrid"></div>
  </div>
</div>

<div class="overlay" id="reminderOverlay" onclick="closeReminder(event)">
  <div class="sheet"><div class="sheet-handle"></div>
    <div class="serif" style="font-size:20px;font-style:italic;text-align:center;margin-bottom:8px">Set Reminder ‚è∞</div>
    <div id="remName" style="font-size:15px;font-weight:600;text-align:center;margin-bottom:16px"></div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <label class="mono" style="font-size:11px;color:#8888a8;flex:1">Remind me at</label>
      <input type="time" class="tin" id="remTime" value="08:00">
    </div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
      <label class="mono" style="font-size:11px;color:#8888a8;flex:1">Repeat</label>
      <select class="tin" id="remRepeat"><option>Every day</option><option>Weekdays only</option><option>Weekends only</option></select>
    </div>
    <button class="btn-lime" onclick="saveReminder()" style="display:block;width:100%;padding:13px;font-size:15px;margin-top:10px">Save Reminder üîî</button>
    <button onclick="closeReminder()" style="display:block;width:100%;padding:10px;background:none;border:none;color:#50506a;font-size:14px;cursor:pointer;margin-top:6px">Cancel</button>
  </div>
</div>

<!-- Block creation/edit sheet -->
<div class="overlay" id="blockSheet" onclick="if(event.target===this)closeBlockSheet()">
  <div class="sheet" style="max-height:88vh;overflow-y:auto">
    <div class="sheet-handle"></div>
    <div class="serif" id="blockSheetTitle" style="font-size:20px;font-style:italic;text-align:center;margin-bottom:16px">New Block</div>

    <label class="field-lbl">Block name</label>
    <input class="field-inp" id="blkTitle" placeholder="e.g. Morning Routine, Gym, Class">

    <label class="field-lbl">Type</label>
    <select class="field-inp" id="blkType" onchange="updateBlkTypeUI()" style="cursor:pointer">
      <option value="habit">üå± Habit block</option>
      <option value="class">üìö Class (repeating)</option>
      <option value="event">üìå Event / appointment</option>
      <option value="sleep">üò¥ Sleep / wake alarm</option>
      <option value="todo">‚úÖ To-do block</option>
    </select>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      <div><label class="field-lbl">Start</label><input class="field-inp" id="blkStart" type="time" value="07:30"></div>
      <div><label class="field-lbl">End</label><input class="field-inp" id="blkEnd" type="time" value="08:30"></div>
    </div>

    <div id="blkRepeatRow">
      <label class="field-lbl">Repeat on</label>
      <div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px" id="blkDayPicker">
        <button class="day-pick-btn" data-day="0" onclick="toggleBlkDay(0)">Sun</button>
        <button class="day-pick-btn" data-day="1" onclick="toggleBlkDay(1)">Mon</button>
        <button class="day-pick-btn" data-day="2" onclick="toggleBlkDay(2)">Tue</button>
        <button class="day-pick-btn" data-day="3" onclick="toggleBlkDay(3)">Wed</button>
        <button class="day-pick-btn" data-day="4" onclick="toggleBlkDay(4)">Thu</button>
        <button class="day-pick-btn" data-day="5" onclick="toggleBlkDay(5)">Fri</button>
        <button class="day-pick-btn" data-day="6" onclick="toggleBlkDay(6)">Sat</button>
      </div>
    </div>

    <div id="blkDateRow" style="display:none">
      <label class="field-lbl">Date</label>
      <input class="field-inp" id="blkDate" type="date">
    </div>

    <!-- Habit attachment (shown for habit blocks) -->
    <div id="blkHabitSection">
      <label class="field-lbl">Attach habit categories</label>
      <div class="mono" style="font-size:10px;color:#50506a;margin-bottom:8px">Habits in these categories will show inside this block. Also auto-matches habits whose reminder time falls within the block window.</div>
      <div id="blkCatPicker" style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px"></div>
    </div>

    <label class="field-lbl">Color</label>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <div class="col-pick" data-color="#c8f564" onclick="pickBlkColor('#c8f564')" style="background:#c8f564"></div>
      <div class="col-pick" data-color="#64c8f5" onclick="pickBlkColor('#64c8f5')" style="background:#64c8f5"></div>
      <div class="col-pick" data-color="#f564a9" onclick="pickBlkColor('#f564a9')" style="background:#f564a9"></div>
      <div class="col-pick" data-color="#f5c842" onclick="pickBlkColor('#f5c842')" style="background:#f5c842"></div>
      <div class="col-pick" data-color="#a064f5" onclick="pickBlkColor('#a064f5')" style="background:#a064f5"></div>
      <div class="col-pick" data-color="#64f5b8" onclick="pickBlkColor('#64f5b8')" style="background:#64f5b8"></div>
    </div>

    <label class="field-lbl">Notification</label>
    <select class="field-inp" id="blkReminder" style="cursor:pointer;margin-bottom:16px">
      <option value="0">At start time</option>
      <option value="5">5 min before</option>
      <option value="10" selected>10 min before</option>
      <option value="15">15 min before</option>
      <option value="30">30 min before</option>
    </select>

    <button class="btn-lime" id="blkSaveBtn" onclick="saveBlock()" style="display:block;width:100%;padding:13px;font-size:15px;margin-bottom:8px">Add Block ‚úì</button>
    <button id="blkDeleteBtn" onclick="deleteBlock()" style="display:none;width:100%;padding:11px;background:none;border:1px solid #f56464;border-radius:12px;color:#f56464;font-size:14px;cursor:pointer;margin-bottom:8px">Delete Block</button>
    <button onclick="closeBlockSheet()" style="display:block;width:100%;padding:10px;background:none;border:none;color:#50506a;font-size:14px;cursor:pointer">Cancel</button>
  </div>
</div>

<!-- Block detail sheet (tap block to open) -->
<div class="overlay" id="blockDetailSheet" onclick="if(event.target===this)closeBlockDetail()">
  <div class="sheet" style="max-height:88vh;overflow-y:auto">
    <div class="sheet-handle"></div>
    <div id="blockDetailContent"></div>
  </div>
</div>

<!-- Todo quick-add sheet -->
<div class="overlay" id="todoSheet" onclick="if(event.target===this)closeTodoSheet()">
  <div class="sheet"><div class="sheet-handle"></div>
    <div class="serif" style="font-size:20px;font-style:italic;text-align:center;margin-bottom:16px">Add To-Do</div>
    <label class="field-lbl">Task</label>
    <input class="field-inp" id="todoInp" placeholder="What needs to get done?" onkeydown="if(event.key==='Enter')saveTodo()">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      <div>
        <label class="field-lbl">Day</label>
        <select class="field-inp" id="todoDay" style="cursor:pointer">
          <option value="today">Today</option>
          <option value="tomorrow">Tomorrow</option>
          <option value="sun">Sunday</option>
          <option value="mon">Monday</option>
          <option value="tue">Tuesday</option>
          <option value="wed">Wednesday</option>
          <option value="thu">Thursday</option>
          <option value="fri">Friday</option>
          <option value="sat">Saturday</option>
        </select>
      </div>
      <div>
        <label class="field-lbl">Time (optional)</label>
        <input class="field-inp" id="todoTime" type="time" value="">
      </div>
    </div>
    <button class="btn-lime" onclick="saveTodo()" style="display:block;width:100%;padding:13px;font-size:15px">Add ‚úì</button>
    <button onclick="closeTodoSheet()" style="display:block;width:100%;padding:10px;background:none;border:none;color:#50506a;font-size:14px;cursor:pointer;margin-top:6px">Cancel</button>
  </div>
</div>
</div><!-- /app -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE CONFIG
// Paste your own URL and anon key here after
// following the setup guide.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://gpeaawapenxjnslmovcl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZWFhd2FwZW54am5zbG1vdmNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NzU4NTIsImV4cCI6MjA4NzU1MTg1Mn0.dksjfHFJTEpAsBs2TDDGtqsABhVK5vVpbK1wb-G94gw';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚îÄ‚îÄ Local cache so the UI stays fast ‚îÄ‚îÄ
const LS = {
  get: k => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : null; } catch { return null; } },
  set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} },
  del: k => localStorage.removeItem(k),
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LOAD / SAVE  (Supabase as source of truth,
// localStorage as instant local cache)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;   // Supabase user object
let S = null;             // habit data object

function genCode(email) {
  return 'GLW' + email.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,5).padEnd(5,'X');
}

async function loadData() {
  const uid = currentUser.id;
  const today = new Date().toDateString();

  // Try local cache first for instant render
  const cached = LS.get('glowup_data_' + uid);
  if (cached) {
    S = cached;
    render(currentTab);
  }

  // Always fetch fresh from Supabase
  const { data, error } = await sb
    .from('user_data')
    .select('data')
    .eq('user_id', uid)
    .single();

  if (data?.data) {
    S = data.data;
  } else if (!S) {
    S = freshData();
  }

  // Handle day rollover
  if (S.lastDate !== today) {
    if (S.lastDate) {
      const pct = calcPct();
      S.dayHistory = S.dayHistory || {};
      S.dayHistory[S.lastDate] = pct;
      if (pct === 100) S.perfectDays = (S.perfectDays || 0) + 1;
    }
    S.cats = S.cats.map(c => ({
      ...c,
      subs: c.subs.map(h => ({
        ...h,
        streak: h.done ? (h.streak||0)+1 : 0,
        bestStreak: Math.max(h.bestStreak||0, h.done ? (h.streak||0)+1 : 0),
        done: false
      }))
    }));
    S.lastDate = today;
  }

  LS.set('glowup_data_' + uid, S);
  render(currentTab);
  await pushLeaderboard();
}

// Save to both local cache AND Supabase
let saveTimer;
async function saveData() {
  if (!currentUser || !S) return;
  const uid = currentUser.id;
  LS.set('glowup_data_' + uid, S);
  await sb.from('user_data').upsert({ user_id: uid, data: S, updated_at: new Date().toISOString() });
  await pushLeaderboard();
}

function debounceSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveData, 800);
}

async function pushLeaderboard() {
  if (!currentUser || !S) return;
  const uid = currentUser.id;
  const profile = LS.get('glowup_profile_' + uid) || {};
  const allSubs = S.cats.flatMap(c => c.subs);
  const streak = Math.max(...allSubs.map(s => s.streak||0), 0);
  const pct = calcPct();
  const code = profile.friend_code || genCode(currentUser.email || uid);
  await sb.from('leaderboard').upsert({
    user_id: uid,
    display_name: profile.display_name || currentUser.email?.split('@')[0] || 'Friend',
    friend_code: code,
    streak,
    today_pct: pct,
    perfect_days: S.perfectDays || 0,
    updated_at: new Date().toISOString()
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH  (Supabase handles passwords securely ‚Äî
// bcrypt hashing, sessions, everything)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let authModeVal = 'login';

function switchAuth(mode) {
  authModeVal = mode;
  document.getElementById('ltLogin').classList.toggle('active', mode==='login');
  document.getElementById('ltReg').classList.toggle('active', mode==='register');
  document.getElementById('displayNameField').style.display = mode==='register' ? 'block' : 'none';
  document.getElementById('authBtn').textContent = mode==='login' ? 'Sign In ‚Üí' : 'Create Account ‚Üí';
  document.getElementById('authErr').textContent = '';
}

async function handleAuth() {
  const email = document.getElementById('authUser').value.trim().toLowerCase();
  const password = document.getElementById('authPass').value;
  const display = document.getElementById('authDisplay')?.value.trim() || '';
  const errEl = document.getElementById('authErr');
  const btn = document.getElementById('authBtn');
  errEl.textContent = '';

  // Basic validation
  if (!email || !password) { errEl.textContent = 'Please fill in all fields.'; return; }
  if (!email.includes('@')) { errEl.textContent = 'Please enter a valid email address.'; return; }

  btn.textContent = 'Please wait‚Ä¶';
  btn.disabled = true;

  if (authModeVal === 'register') {
    if (!display) { errEl.textContent = 'Please enter your name.'; btn.textContent='Create Account ‚Üí'; btn.disabled=false; return; }
    if (password.length < 6) { errEl.textContent = 'Password must be 6+ characters.'; btn.textContent='Create Account ‚Üí'; btn.disabled=false; return; }

    const { data, error } = await sb.auth.signUp({ email, password });
    if (error) { errEl.textContent = error.message; btn.textContent='Create Account ‚Üí'; btn.disabled=false; return; }

    // Save display name and friend code to profiles table
    const uid = data.user.id;
    const code = genCode(email);
    await sb.from('profiles').upsert({ user_id: uid, display_name: display||email.split('@')[0], friend_code: code, emoji: 'üåü' });
    LS.set('glowup_profile_' + uid, { display_name: display||email.split('@')[0], friend_code: code, emoji: 'üåü' });

    // Supabase may require email confirmation ‚Äî handle both cases
    if (data.session) {
      currentUser = data.user;
      await finishLogin();
    } else {
      errEl.style.color = '#c8f564';
      errEl.textContent = 'Check your email to confirm your account, then sign in!';
      switchAuth('login');
    }
  } else {
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) { errEl.textContent = 'Wrong email or password.'; btn.textContent='Sign In ‚Üí'; btn.disabled=false; return; }
    currentUser = data.user;
    await finishLogin();
  }

  btn.textContent = authModeVal==='login' ? 'Sign In ‚Üí' : 'Create Account ‚Üí';
  btn.disabled = false;
}

async function finishLogin() {
  // Load cached profile
  const uid = currentUser.id;
  let profile = LS.get('glowup_profile_' + uid);
  if (!profile) {
    const { data } = await sb.from('profiles').select('*').eq('user_id', uid).single();
    if (data) {
      profile = { display_name: data.display_name, friend_code: data.friend_code, emoji: data.emoji||'üåü' };
      LS.set('glowup_profile_' + uid, profile);
    } else {
      // Create profile if somehow missing
      const code = genCode(currentUser.email || uid);
      profile = { display_name: currentUser.email?.split('@')[0] || 'Friend', friend_code: code };
      await sb.from('profiles').upsert({ user_id: uid, ...profile });
      LS.set('glowup_profile_' + uid, profile);
    }
  }

  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  go('today');
  await loadData();
}

async function logout() {
  if (!confirm('Sign out?')) return;
  await sb.auth.signOut();
  currentUser = null; S = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('authUser').value = '';
  document.getElementById('authPass').value = '';
  switchAuth('login');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEFAULT DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function freshData() {
  return {
    cats: [
      {id:1,name:'Morning Routine',icon:'üåÖ',open:false,totalDone:0,subs:[
        {id:11,name:'Wake up at 8 AM',streak:0,bestStreak:0,done:false,reminder:'08:00',totalDone:0},
        {id:12,name:'Drink water immediately',streak:0,bestStreak:0,done:false,reminder:'08:05',totalDone:0},
        {id:13,name:'Make bed',streak:0,bestStreak:0,done:false,reminder:'',totalDone:0},
      ]},
      {id:2,name:'Skincare Routine',icon:'üåø',open:false,totalDone:0,subs:[
        {id:21,name:'Wash face (AM)',streak:0,bestStreak:0,done:false,reminder:'08:15',totalDone:0},
        {id:22,name:'Moisturize & SPF',streak:0,bestStreak:0,done:false,reminder:'08:20',totalDone:0},
        {id:23,name:'Evening cleanse',streak:0,bestStreak:0,done:false,reminder:'21:00',totalDone:0},
        {id:24,name:'Night moisturizer',streak:0,bestStreak:0,done:false,reminder:'21:10',totalDone:0},
      ]},
      {id:3,name:'Shower & Body Care',icon:'üöø',open:false,totalDone:0,subs:[
        {id:31,name:'Shower',streak:0,bestStreak:0,done:false,reminder:'',totalDone:0},
        {id:32,name:'Body lotion / oil',streak:0,bestStreak:0,done:false,reminder:'',totalDone:0},
        {id:33,name:'Look presentable',streak:0,bestStreak:0,done:false,reminder:'09:00',totalDone:0},
      ]},
      {id:4,name:'Nourishment',icon:'ü•ó',open:false,totalDone:0,subs:[
        {id:41,name:'Eat per meal plan',streak:0,bestStreak:0,done:false,reminder:'12:00',totalDone:0},
        {id:42,name:'Drink 8 glasses of water',streak:0,bestStreak:0,done:false,reminder:'10:00',totalDone:0},
        {id:43,name:'No skipping meals',streak:0,bestStreak:0,done:false,reminder:'',totalDone:0},
      ]},
      {id:5,name:'School & Growth',icon:'üìö',open:false,totalDone:0,subs:[
        {id:51,name:'Finish homework',streak:0,bestStreak:0,done:false,reminder:'16:00',totalDone:0},
        {id:52,name:'Review class notes',streak:0,bestStreak:0,done:false,reminder:'17:00',totalDone:0},
        {id:53,name:'Learn something new',streak:0,bestStreak:0,done:false,reminder:'',totalDone:0},
      ]},
      {id:6,name:'Mind & Soul',icon:'‚ú®',open:false,totalDone:0,subs:[
        {id:61,name:'Journal / Reflect',streak:0,bestStreak:0,done:false,reminder:'21:00',totalDone:0},
        {id:62,name:'5-min breathing',streak:0,bestStreak:0,done:false,reminder:'',totalDone:0},
        {id:63,name:'Gratitude moment',streak:0,bestStreak:0,done:false,reminder:'',totalDone:0},
      ]},
    ],
    weekly: [
      {key:'meal',title:'Meal Planning & Prep',icon:'ü•ó',open:true,items:[{id:'m1',text:'Plan meals for the week',done:false},{id:'m2',text:'Write grocery list',done:false},{id:'m3',text:'Prep lunches / snacks',done:false},{id:'m4',text:'Prep dinners if possible',done:false}],r1:'',r2:'',r3:''},
      {key:'laundry',title:'Laundry & Clothes',icon:'üëó',open:false,items:[{id:'l1',text:'Do laundry',done:false},{id:'l2',text:'Fold & put away',done:false},{id:'l3',text:'Plan outfits for the week',done:false}],r1:'',r2:'',r3:''},
      {key:'hw',title:'Homework Planning',icon:'üìö',open:false,items:[{id:'h1',text:'List all assignments due',done:false},{id:'h2',text:'Break into daily tasks',done:false},{id:'h3',text:'Set deadlines for each',done:false},{id:'h4',text:'Check upcoming tests',done:false}],r1:'',r2:'',r3:''},
      {key:'self',title:'Self-Care Planning',icon:'üíÜ',open:false,items:[{id:'s1',text:'Schedule time just for me',done:false},{id:'s2',text:'Social plan',done:false},{id:'s3',text:'Rest & sleep intention',done:false}],r1:'',r2:'',r3:''},
      {key:'review',title:'Weekly Reflection',icon:'üåü',open:false,isReflection:true,items:[],r1:'',r2:'',r3:''},
    ],
    lastDate: new Date().toDateString(),
    dayHistory: {},
    perfectDays: 0,
    entries: [],
    goals: [],
    struggles: [],
    identity: {statement:'',values:'',growing:'',love:'',release:''},
    friends: [],
    morningDigestTime: '08:00',
    schedBlocks: [],
    todos: [],
  };
}

function calcPct() {
  const all = S.cats.flatMap(c=>c.subs);
  return all.length ? Math.round(all.filter(s=>s.done).length / all.length * 100) : 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTab = 'today';
function go(name) {
  currentTab = name;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelector(`[data-page="${name}"]`)?.classList.add('active');
  window.scrollTo({top:0});
  render(name);
}

function renderAll() { render('today'); }
function render(name) {
  if (!S) {
    // Data not loaded yet ‚Äî show a loading state in the active page
    const el = document.getElementById('page-' + name);
    if (el) el.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;gap:12px"><div style="font-size:32px">‚ú®</div><div class="mono" style="font-size:11px;color:#50506a;letter-spacing:2px">LOADING‚Ä¶</div></div>';
    return;
  }
  if (name === 'today') renderToday();
  else if (name === 'weekly') renderWeekly();
  else if (name === 'journal') renderJournal();
  else if (name === 'progress') renderProgress();
  else if (name === 'schedule') renderSchedule();
  else if (name === 'friends') renderFriends();
  else if (name === 'me') renderMe();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TODAY PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EMOJIS = ['üåÖ','üåø','üöø','ü•ó','üìö','‚ú®','‚≠ê','üéØ','üí´','üå±','üîë','üíé','üöÄ','üßò','üèÉ','üìñ','üé®','üß¥','üíß','üçé','üß†','‚ù§Ô∏è','üå∏','üåô','‚òÄÔ∏è','üèãÔ∏è','üéµ','‚úçÔ∏è','üßπ','üëó','üí§','üõÅ','ü™•','üíä','üèÉ‚Äç‚ôÄÔ∏è','ü¶ã','üåä','üéÄ','üå∫','üíê'];

function renderTodayTodos() {
  const todayStr = new Date().toISOString().slice(0,10);
  const todos = (S.todos||[]).filter(t=>t.date===todayStr);
  if (!todos.length) return `
    <div style="padding:14px 18px 0">
      <span class="sec-lbl" style="padding:0 0 10px">To-Do Today</span>
      <button onclick="openTodoSheet()" style="display:flex;align-items:center;gap:8px;width:100%;padding:11px 14px;background:#14141a;border:1px dashed #262636;border-radius:12px;color:#50506a;font-size:13px;cursor:pointer;text-align:left">
        <span style="font-size:16px">‚úÖ</span> Add a to-do for today‚Ä¶
      </button>
    </div>`;
  return `
    <div style="padding:14px 18px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <span class="sec-lbl" style="padding:0">To-Do Today</span>
        <button onclick="openTodoSheet()" style="background:none;border:none;color:#c8f564;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer">+ Add</button>
      </div>
      ${todos.map(t=>`
        <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:#14141a;border:1px solid ${t.done?'#1a1a24':'#32324a'};border-radius:10px;margin-bottom:6px">
          <div onclick="toggleTodo('${t.id}')" style="width:20px;height:20px;border-radius:50%;border:2px solid ${t.done?'#c8f564':'#32324a'};background:${t.done?'#c8f564':'transparent'};display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;font-size:10px;color:#0d0d0f">${t.done?'‚úì':''}</div>
          <span style="flex:1;font-size:13px;font-weight:500;color:${t.done?'#50506a':'#e8e8f0'};text-decoration:${t.done?'line-through':'none'}">${esc(t.text)}${t.time?`<span style="font-family:'DM Mono',monospace;font-size:9px;color:#50506a;margin-left:6px">${fmtTime(t.time)}</span>`:''}</span>
          <div style="display:flex;gap:4px">
            <button onclick="moveTodoTomorrow('${t.id}')" title="Push to tomorrow" style="background:none;border:none;font-size:13px;cursor:pointer;color:#50506a">‚Üí</button>
            <button onclick="deleteTodo('${t.id}')" style="background:none;border:none;color:#f56464;font-size:12px;cursor:pointer">‚úï</button>
          </div>
        </div>`).join('')}
    </div>`;
}

function renderToday() {
  const h = new Date().getHours();
  const greet = h<12?'Good morning ‚ú®':h<17?'Good afternoon ‚òÄÔ∏è':'Good evening üåô';
  const allSubs = S.cats.flatMap(c=>c.subs);
  const done = allSubs.filter(s=>s.done).length;
  const total = allSubs.length;
  const pct = total ? Math.round(done/total*100) : 0;
  const maxStreak = Math.max(...allSubs.map(s=>s.streak||0), 0);
  const C = 188.4;
  const offset = C - (pct/100)*C;
  const msgs = ["Let's get started üí™","Keep going üå±","Halfway there ‚ö°","Almost there! üî•","On fire! üåü","PERFECT DAY üèÜ"];
  const msg = msgs[Math.min(Math.floor(pct/20),5)];

  // Weekly tasks assigned to today
  const todayDay = new Date().getDay();
  const todayWkItems = S.weekly.filter(s=>!s.isReflection).flatMap(s=>s.items.filter(it=>it.day===todayDay));
  const todayWkHtml = todayWkItems.length ? `
    <div style="padding:0 14px;margin-bottom:12px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#64c8f5;text-transform:uppercase;display:block;margin-bottom:10px">üìÖ Today's Weekly Tasks</div>
      <div style="background:#14141a;border:1px solid #64c8f5;border-radius:14px;overflow:hidden">
        ${todayWkItems.map(it=>`
          <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #262636;background:${it.done?'rgba(100,200,245,.03)':'transparent'}">
            <div onclick="toggleWkItemByRef('${it.id}')" style="width:22px;height:22px;border-radius:50%;border:2px solid ${it.done?'#64c8f5':'#32324a'};display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;background:${it.done?'#64c8f5':'transparent'};color:${it.done?'#0d0d0f':'transparent'};font-size:11px">‚úì</div>
            <span style="flex:1;font-size:13px;font-weight:500;color:${it.done?'#50506a':'#e8e8f0'};text-decoration:${it.done?'line-through':'none'}">${esc(it.text)}</span>
          </div>`).join('')}
      </div>
    </div>` : '';

  let catsHtml = S.cats.map(cat => {
    const cd = cat.subs.filter(s=>s.done).length;
    const ct = cat.subs.length;
    const cp = ct ? Math.round(cd/ct*100) : 0;
    const subsHtml = cat.subs.map(sub => `
      <div class="sub-item${sub.done?' done':''}" id="sub-${sub.id}">
        <div class="sub-ck" onclick="toggleSub(${cat.id},${sub.id})">‚úì</div>
        <div style="flex:1;min-width:0">
          <input class="sub-name-inp" value="${esc(sub.name)}" onchange="updateSubName(${cat.id},${sub.id},this.value)">
          <div style="display:flex;align-items:center;gap:6px;margin-top:3px">
            ${sub.streak>0?`<span class="sub-streak">üî• ${sub.streak}d</span>`:''}
            <span class="rem-tag" onclick="openReminder(${cat.id},${sub.id})">${sub.reminder||'‚è∞ set'}</span>
          </div>
        </div>
        <button class="sub-del" onclick="deleteSub(${cat.id},${sub.id})">‚úï</button>
      </div>`).join('');
    return `
      <div class="cat-wrap">
        <div class="cat-hd${cat.open?' open':''}" id="cathd-${cat.id}">
          <div class="cat-ic" onclick="openEmojiPicker(${cat.id})">${cat.icon}</div>
          <div style="flex:1;min-width:0">
            <input class="cat-name-inp" value="${esc(cat.name)}" onclick="event.stopPropagation()" onchange="updateCatName(${cat.id},this.value)">
            <div class="cat-pg">${cd} of ${ct} done</div>
            <div class="minibar">
              <div class="minibar-track"><div class="minibar-fill" style="width:${cp}%"></div></div>
              <div class="minibar-pct">${cp}%</div>
            </div>
          </div>
          <button class="cat-del" onclick="event.stopPropagation();deleteCat(${cat.id})">‚úï</button>
          <span class="cat-ch">‚ñº</span>
        </div>
        <div class="sub-list${cat.open?' open':''}" id="sublist-${cat.id}">
          ${subsHtml}
          <div class="add-sub-row">
            <input class="add-sub-inp" id="asi-${cat.id}" placeholder="Add habit to this category‚Ä¶" onkeydown="if(event.key==='Enter')addSub(${cat.id})">
            <button style="background:none;border:1px solid #c8f564;border-radius:7px;padding:3px 10px;color:#c8f564;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer" onclick="addSub(${cat.id})">+</button>
          </div>
        </div>
      </div>`;
  }).join('');

  document.getElementById('page-today').innerHTML = `
    <div class="ph">
      <div class="mono" style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#c8f564;display:block;margin-bottom:6px">${greet}</div>
      <div class="serif" style="font-size:32px;font-weight:700;line-height:1.15;display:block">Today is your<br><em style="color:#c8f564">day to show up.</em></div>
    </div>
    <div class="mono" style="display:block;padding:0 18px 14px;font-size:10px;color:#50506a">${new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</div>

    <div style="display:flex;align-items:center;gap:16px;padding:14px 18px;background:#14141a;border-top:1px solid #262636;border-bottom:1px solid #262636;margin-bottom:20px">
      <div class="ring-wrap">
        <svg width="68" height="68" viewBox="0 0 68 68">
          <defs><linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#c8f564"/><stop offset="100%" stop-color="#64c8f5"/></linearGradient></defs>
          <circle class="ring-track" cx="34" cy="34" r="30"/>
          <circle class="ring-fill" cx="34" cy="34" r="30" style="stroke-dashoffset:${offset}"/>
        </svg>
        <div class="ring-pct">${pct}%</div>
      </div>
      <div style="flex:1">
        <div class="serif" style="font-size:22px;font-weight:700;line-height:1">${done} <span style="font-size:12px;color:#50506a;font-family:'DM Sans',sans-serif;font-weight:400">/ ${total} done</span></div>
        <div class="mono" style="font-size:10px;color:#8888a8;margin-top:4px;display:block">${msg}</div>
      </div>
      <div style="text-align:center">
        <div style="font-size:22px">üî•</div>
        <div class="serif" style="font-size:20px;font-weight:700;color:#f5c842;line-height:1">${maxStreak}</div>
        <div class="mono" style="font-size:9px;color:#50506a;text-transform:uppercase;letter-spacing:1px">day streak</div>
      </div>
    </div>

    ${todayWkHtml}
    <span class="sec-lbl">Habit Categories</span>
    ${catsHtml}
    <div class="add-row">
      <input class="add-inp" id="newCatInp" placeholder="New category (e.g. Evening Routine)" onkeydown="if(event.key==='Enter')addCategory()">
      <button class="btn-lime" onclick="addCategory()" style="padding:0 16px;font-size:14px">+ Add</button>
    </div>
    ${renderTodayTodos()}`;

  // Re-attach cat toggle listeners
  S.cats.forEach(cat => {
    const hd = document.getElementById('cathd-'+cat.id);
    if (hd) hd.addEventListener('click', (e) => {
      if (e.target.tagName==='INPUT'||e.target.tagName==='BUTTON') return;
      toggleCat(cat.id);
    });
  });
}

function toggleWkItemByRef(itemId) {
  S.weekly.forEach(sec => sec.items.forEach(it => {
    if(it.id===itemId) it.done=!it.done;
  }));
  debounceSave(); renderToday();
}
function toggleCat(id) {
  const cat = S.cats.find(c=>c.id===id);
  if (cat) cat.open = !cat.open;
  debounceSave();
  renderToday();
}
function updateCatName(id, val) {
  const cat = S.cats.find(c=>c.id===id);
  if (cat) { cat.name = val; debounceSave(); }
}
function deleteCat(id) {
  if (!confirm('Delete this category?')) return;
  S.cats = S.cats.filter(c=>c.id!==id);
  debounceSave(); renderToday();
}
function toggleSub(cid, sid) {
  const cat = S.cats.find(c=>c.id===cid);
  const sub = cat?.subs.find(s=>s.id===sid);
  if (!sub) return;
  sub.done = !sub.done;
  if (sub.done) { sub.totalDone=(sub.totalDone||0)+1; cat.totalDone=(cat.totalDone||0)+1; }
  debounceSave(); renderToday();
  if (sub.done) toast(`${sub.name} ‚úì`);
}
function updateSubName(cid, sid, val) {
  const sub = S.cats.find(c=>c.id===cid)?.subs.find(s=>s.id===sid);
  if (sub) { sub.name = val; debounceSave(); }
}
function deleteSub(cid, sid) {
  const cat = S.cats.find(c=>c.id===cid);
  if (cat) { cat.subs = cat.subs.filter(s=>s.id!==sid); debounceSave(); renderToday(); }
}
function addSub(cid) {
  const inp = document.getElementById('asi-'+cid);
  const name = inp?.value.trim();
  if (!name) return;
  const cat = S.cats.find(c=>c.id===cid);
  if (cat) { cat.subs.push({id:Date.now(),name,streak:0,bestStreak:0,done:false,reminder:'',totalDone:0}); }
  inp.value = ''; debounceSave(); renderToday(); toast('Habit added ‚ú®');
}
function addCategory() {
  const inp = document.getElementById('newCatInp');
  const name = inp?.value.trim();
  if (!name) return;
  const icons = ['‚≠ê','üéØ','üí´','üå±','üîë','üíé','üöÄ','üßò'];
  S.cats.push({id:Date.now(),name,icon:icons[S.cats.length%icons.length],open:true,totalDone:0,subs:[]});
  inp.value = ''; debounceSave(); renderToday(); toast(`"${name}" added ‚ú®`);
}

// ‚îÄ‚îÄ EMOJI PICKER ‚îÄ‚îÄ
let emojiForCat = null;
function openEmojiPicker(catId) {
  emojiForCat = catId;
  const grid = document.getElementById('emojiGrid');
  grid.innerHTML = EMOJIS.map(em => `<button class="em-btn" onclick="pickEmoji('${em}')">${em}</button>`).join('');
  document.getElementById('emojiOverlay').classList.add('open');
}
function pickEmoji(em) {
  if (wkEmojiFor !== null) { pickWkEmoji(em); return; }
  const cat = S.cats.find(c=>c.id===emojiForCat);
  if (cat) { cat.icon = em; debounceSave(); renderToday(); }
  document.getElementById('emojiOverlay').classList.remove('open');
}
function closeEmoji(e) { if (e.target===document.getElementById('emojiOverlay')) document.getElementById('emojiOverlay').classList.remove('open'); }

// ‚îÄ‚îÄ REMINDERS ‚îÄ‚îÄ
let remCatId, remSubId;
function openReminder(cid, sid) {
  remCatId = cid; remSubId = sid;
  const sub = S.cats.find(c=>c.id===cid)?.subs.find(s=>s.id===sid);
  document.getElementById('remName').textContent = sub?.name || '';
  document.getElementById('remTime').value = sub?.reminder || '08:00';
  document.getElementById('reminderOverlay').classList.add('open');
}
function saveReminder() {
  const t = document.getElementById('remTime').value;
  if (window._reminderTarget === 'weekly') {
    if (S.weekly[wkRemSi]?.items[wkRemIi]) { S.weekly[wkRemSi].items[wkRemIi].reminder=t; debounceSave(); renderWeekly(); }
    window._reminderTarget = null;
  } else {
    const sub = S.cats.find(c=>c.id===remCatId)?.subs.find(s=>s.id===remSubId);
    if (sub) { sub.reminder = t; debounceSave(); renderToday(); }
  }
  document.getElementById('reminderOverlay').classList.remove('open');
  requestNotifPermission();
  toast(`Reminder set for ${t} üîî`);
}
function closeReminder(e) { if (!e || e.target===document.getElementById('reminderOverlay')) document.getElementById('reminderOverlay').classList.remove('open'); }

function requestNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(p => { if(p==='granted') toast('Notifications enabled üîî'); });
  }
}

function glowNotif(title, body) {
  if (Notification.permission !== 'granted') return;
  new Notification(title, {
    body,
    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚ú®</text></svg>',
    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚ú®</text></svg>'
  });
}

// Track which notifications fired this session
const _notifFired = new Set();

function checkNotifications() {
  if (Notification.permission !== 'granted' || !S) return;
  const now = new Date();
  const todayDay = now.getDay();
  const hhmm = String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  const hh = now.getHours(), mm = now.getMinutes();
  const totalMins = hh*60+mm;

  // ‚îÄ‚îÄ Morning summary ‚îÄ‚îÄ
  const mornTime = S.morningDigestTime || '08:00';
  const mornKey = 'morning_' + now.toDateString();
  if (hhmm === mornTime && !_notifFired.has(mornKey)) {
    _notifFired.add(mornKey);
    const allSubs = S.cats.flatMap(c=>c.subs);
    const todayEvents = (S.scheduleEvents||[]).filter(ev => {
      if (ev.type==='class'||ev.type==='habit') return (ev.days||[]).includes(todayDay);
      if (ev.type==='event'||ev.type==='deadline') return ev.date === now.toISOString().slice(0,10);
      return false;
    });
    const lines = [];
    if (allSubs.length) lines.push(`${allSubs.length} habits to complete`);
    todayEvents.forEach(ev => lines.push(`${ev.start} ${ev.title}`));
    const wkToday = S.weekly.filter(s=>!s.isReflection).flatMap(s=>s.items.filter(it=>it.day===todayDay&&!it.done));
    if (wkToday.length) lines.push(`${wkToday.length} weekly tasks`);
    if (lines.length) glowNotif("Good morning! Here's your day ‚ú®", lines.join(' ¬∑ '));
  }

  // ‚îÄ‚îÄ Habit reminders ‚îÄ‚îÄ
  S.cats.forEach(cat => cat.subs.forEach(sub => {
    if (!sub.reminder || sub.done) return;
    const key = 'hab_' + sub.id + '_' + now.toDateString();
    if (sub.reminder === hhmm && !_notifFired.has(key)) {
      _notifFired.add(key);
      glowNotif('GlowUp ‚ú®', 'Time for: ' + sub.name);
    }
  }));

  // ‚îÄ‚îÄ Schedule block reminders ‚îÄ‚îÄ
  (S.schedBlocks||[]).forEach(blk => {
    const appliesToday = (blk.type==='class'||blk.type==='habit'||blk.type==='sleep')
      ? (blk.days||[]).includes(todayDay)
      : blk.date === now.toISOString().slice(0,10);
    if (!appliesToday || !blk.start) return;
    const [bh,bm] = blk.start.split(':').map(Number);
    const blkMins = bh*60+bm;
    const remMins = parseInt(blk.reminder)||0;
    const fireAt = blkMins - remMins;
    const key = 'blk_' + blk.id + '_' + now.toDateString();
    if (totalMins === fireAt && !_notifFired.has(key)) {
      _notifFired.add(key);
      if (blk.type === 'habit') {
        // Show habit stack notification
        const habits = getHabitsForBlock(blk);
        const habitNames = habits.filter(h=>!h.done).map(h=>h.name).slice(0,4);
        const body = habitNames.length
          ? habitNames.join(' ¬∑ ') + (habits.length>4?` + ${habits.length-4} more`:'')
          : fmtTime(blk.start) + (blk.end?' ‚Äì '+fmtTime(blk.end):'');
        glowNotif('üå± ' + blk.title, body);
      } else if (blk.type === 'sleep') {
        glowNotif('üò¥ ' + blk.title, remMins>0 ? `In ${remMins} minutes` : 'Time to sleep / wake up!');
      } else {
        glowNotif('‚è∞ ' + blk.title, fmtTime(blk.start) + (blk.end?' ‚Äì '+fmtTime(blk.end):''));
      }
    }
  });
  // ‚îÄ‚îÄ Todo reminders ‚îÄ‚îÄ
  const todayStr = now.toISOString().slice(0,10);
  (S.todos||[]).filter(t=>t.date===todayStr&&t.time&&!t.done).forEach(t=>{
    const key='todo_'+t.id+'_'+now.toDateString();
    if(t.time===hhmm&&!_notifFired.has(key)){
      _notifFired.add(key);
      glowNotif('‚úÖ To-Do', t.text);
    }
  });
}

setInterval(checkNotifications, 30000); // check every 30s

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEKLY PAGE
// Full rewrite: Sunday reset, history, editable
// categories/tasks, day assignment, reminders
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Get Monday-Sunday week key string
function getWeekKey(date) {
  const d = date || new Date();
  const sun = new Date(d); sun.setDate(d.getDate() - d.getDay());
  return sun.toISOString().slice(0,10);
}

// Check & handle Sunday reset
function checkWeeklyReset() {
  const wk = getWeekKey();
  if (!S.weeklyMeta) S.weeklyMeta = {};
  if (S.weeklyMeta.weekKey !== wk) {
    // Archive old week
    if (S.weeklyMeta.weekKey) {
      if (!S.weeklyHistory) S.weeklyHistory = [];
      const totalItems = S.weekly.reduce((a,s)=>a+(s.isReflection?0:s.items.length),0);
      const doneItems  = S.weekly.reduce((a,s)=>a+(s.isReflection?0:s.items.filter(i=>i.done).length),0);
      S.weeklyHistory.unshift({
        weekKey: S.weeklyMeta.weekKey,
        pct: totalItems ? Math.round(doneItems/totalItems*100) : 0,
        done: doneItems, total: totalItems,
        sections: JSON.parse(JSON.stringify(S.weekly))
      });
      if (S.weeklyHistory.length > 12) S.weeklyHistory.pop();
    }
    // Reset all items (keep structure, clear done flags)
    S.weekly = S.weekly.map(sec => ({
      ...sec,
      items: sec.items.map(it => ({...it, done:false})),
      r1:'', r2:'', r3:''
    }));
    S.weeklyMeta.weekKey = wk;
    debounceSave();
  }
}

let weekTab = 'plan'; // 'plan' | 'history'

function renderWeekly() {
  if (!S.weeklyMeta) S.weeklyMeta = {};
  checkWeeklyReset();

  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const today = new Date();
  const todayIdx = today.getDay();
  const ws = new Date(today); ws.setDate(today.getDate() - todayIdx);

  // Week progress bar
  const allItems = S.weekly.filter(s=>!s.isReflection).flatMap(s=>s.items);
  const doneCount = allItems.filter(i=>i.done).length;
  const totalCount = allItems.length;
  const weekPct = totalCount ? Math.round(doneCount/totalCount*100) : 0;

  // Day grid ‚Äî show tasks assigned to each day
  const gridHtml = days.map((d,i) => {
    const dt = new Date(ws); dt.setDate(ws.getDate()+i);
    const dayTasks = S.weekly.filter(s=>!s.isReflection).flatMap(s=>s.items).filter(it=>it.day===i);
    const dayDone = dayTasks.filter(it=>it.done).length;
    const isPast = i < todayIdx;
    const isToday = i === todayIdx;
    return `<div class="wd ${isToday?'today':''} ${isPast?'past':''}" onclick="filterByDay(${i})" style="cursor:pointer;position:relative">
      <div class="mono" style="font-size:8px;color:#50506a;text-transform:uppercase">${d}</div>
      <div style="font-size:13px;font-weight:600;color:${isToday?'#64c8f5':isPast?'#c8f564':'#e8e8f0'}">${dt.getDate()}</div>
      ${dayTasks.length?`<div class="mono" style="font-size:8px;color:${dayDone===dayTasks.length&&dayTasks.length>0?'#c8f564':'#8888a8'}">${dayDone}/${dayTasks.length}</div>`:''}
    </div>`;
  }).join('');

  // Tab buttons
  const tabHtml = `
    <div style="display:flex;gap:6px;padding:0 14px 16px">
      <button onclick="setWeekTab('plan')" style="padding:7px 16px;background:${weekTab==='plan'?'rgba(100,200,245,.08)':'#14141a'};border:1px solid ${weekTab==='plan'?'#64c8f5':'#262636'};border-radius:20px;font-family:'DM Mono',monospace;font-size:11px;color:${weekTab==='plan'?'#64c8f5':'#50506a'};cursor:pointer">üìã This Week</button>
      <button onclick="setWeekTab('history')" style="padding:7px 16px;background:${weekTab==='history'?'rgba(200,245,100,.08)':'#14141a'};border:1px solid ${weekTab==='history'?'#c8f564':'#262636'};border-radius:20px;font-family:'DM Mono',monospace;font-size:11px;color:${weekTab==='history'?'#c8f564':'#50506a'};cursor:pointer">üìä History</button>
    </div>`;

  let mainHtml = '';
  if (weekTab === 'history') {
    const hist = S.weeklyHistory || [];
    mainHtml = `<div style="padding:0 14px">` + (hist.length === 0
      ? `<div class="mono" style="font-size:11px;color:#50506a;text-align:center;padding:30px">Complete your first week to see history ‚ú®</div>`
      : hist.map(wk => `
        <div style="background:#14141a;border:1px solid #262636;border-radius:14px;padding:14px;margin-bottom:12px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div class="mono" style="font-size:10px;color:#50506a">Week of ${wk.weekKey}</div>
            <div class="serif" style="font-size:18px;font-weight:700;color:${wk.pct===100?'#c8f564':wk.pct>=70?'#64c8f5':'#8888a8'}">${wk.pct}%</div>
          </div>
          <div style="height:4px;background:#20202d;border-radius:10px;overflow:hidden">
            <div style="height:100%;width:${wk.pct}%;background:${wk.pct===100?'#c8f564':wk.pct>=70?'#64c8f5':'#8888a8'};border-radius:10px"></div>
          </div>
          <div class="mono" style="font-size:10px;color:#50506a;margin-top:6px">${wk.done} of ${wk.total} tasks completed</div>
        </div>`).join('')
    ) + `</div>`;
  } else {
    // Day filter
    const activeDay = typeof S.weeklyDayFilter === 'number' ? S.weeklyDayFilter : -1;
    const dayFilterHtml = `
      <div style="display:flex;gap:5px;padding:0 14px 14px;overflow-x:auto">
        <button onclick="filterByDay(-1)" style="flex-shrink:0;padding:5px 12px;background:${activeDay===-1?'rgba(200,245,100,.08)':'#14141a'};border:1px solid ${activeDay===-1?'#c8f564':'#262636'};border-radius:14px;font-family:'DM Mono',monospace;font-size:10px;color:${activeDay===-1?'#c8f564':'#50506a'};cursor:pointer">All</button>
        ${days.map((d,i)=>`<button onclick="filterByDay(${i})" style="flex-shrink:0;padding:5px 10px;background:${activeDay===i?'rgba(100,200,245,.08)':'#14141a'};border:1px solid ${activeDay===i?'#64c8f5':'#262636'};border-radius:14px;font-family:'DM Mono',monospace;font-size:10px;color:${activeDay===i?'#64c8f5':'#50506a'};cursor:pointer">${d}</button>`).join('')}
      </div>`;

    const sectionsHtml = S.weekly.map((sec, si) => {
      // Filter items by day if filter is active
      const filteredItems = activeDay === -1 ? sec.items : sec.items.filter(it => it.day === activeDay || it.day === undefined);
      const dc = sec.items.filter(i=>i.done).length, tc = sec.items.length;
      const prog = tc ? ` ¬∑ ${dc}/${tc}` : '';
      let bodyHtml;
      if (sec.isReflection) {
        bodyHtml = `
          <span class="ref-lbl">How did this week go?</span>
          <textarea class="ref-ta" id="wkref-${si}-r1" placeholder="3 wins from this week‚Ä¶" onchange="saveWkRef(${si})">${esc(sec.r1||'')}</textarea>
          <span class="ref-lbl">What would I do differently?</span>
          <textarea class="ref-ta" id="wkref-${si}-r2" placeholder="Next week I will‚Ä¶" onchange="saveWkRef(${si})">${esc(sec.r2||'')}</textarea>
          <span class="ref-lbl">My intention for next week</span>
          <textarea class="ref-ta" id="wkref-${si}-r3" placeholder="This week I commit to‚Ä¶" onchange="saveWkRef(${si})">${esc(sec.r3||'')}</textarea>
          <button class="btn-save" onclick="saveWkRefBtn(${si})" style="background:linear-gradient(135deg,#c8f564,#64c8f5);color:#0d0d0f;margin-top:10px">Save Review üåü</button>`;
      } else {
        const itemsHtml = (activeDay===-1 ? sec.items : filteredItems).map((it,ii) => {
          const realIdx = sec.items.indexOf(it);
          return `
          <div class="plan-item ${it.done?'chk':''}">
            <div class="pcb" onclick="toggleWkItem(${si},${realIdx})">‚úì</div>
            <div style="flex:1;min-width:0">
              <input style="background:transparent;border:none;border-bottom:1px solid transparent;outline:none;color:${it.done?'#50506a':'#e8e8f0'};font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;width:100%;text-decoration:${it.done?'line-through':'none'}" value="${esc(it.text)}" onchange="updateWkItemName(${si},${realIdx},this.value)">
              <div style="display:flex;align-items:center;gap:6px;margin-top:3px;flex-wrap:wrap">
                <select onchange="setWkItemDay(${si},${realIdx},this.value)" style="background:#1a1a24;border:1px solid #262636;border-radius:6px;padding:2px 6px;color:#8888a8;font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;outline:none">
                  <option value="" ${it.day===undefined?'selected':''}>Any day</option>
                  ${days.map((d,di)=>`<option value="${di}" ${it.day===di?'selected':''}>${d}</option>`).join('')}
                </select>
                <span class="rem-tag" onclick="openWkReminder(${si},${realIdx})">${it.reminder||'‚è∞ set'}</span>
              </div>
            </div>
            <button style="background:none;border:none;color:#50506a;cursor:pointer;font-size:12px;padding:2px 4px;opacity:.5" onclick="delWkItem(${si},${realIdx})">‚úï</button>
          </div>`;
        }).join('');
        bodyHtml = `
          <div>${itemsHtml}</div>
          <div class="add-plan-row">
            <input class="add-plan-inp" id="wkai-${si}" placeholder="Add task‚Ä¶" onkeydown="if(event.key==='Enter')addWkItem(${si})">
            <button style="background:#c8f564;color:#0d0d0f;border:none;border-radius:8px;padding:7px 14px;font-size:12px;font-weight:600;cursor:pointer" onclick="addWkItem(${si})">+ Add</button>
          </div>`;
      }
      return `
        <div class="ws-block ${sec.open?'open':''}">
          <div class="ws-hd" onclick="toggleWkSec(${si})">
            <div style="display:flex;align-items:center;gap:10px">
              <span style="font-size:17px;cursor:pointer" onclick="event.stopPropagation();openWkEmojiPicker(${si})">${sec.icon}</span>
              <input value="${esc(sec.title)}" onclick="event.stopPropagation()" onchange="updateWkSecName(${si},this.value)"
                style="background:transparent;border:none;border-bottom:1px solid transparent;outline:none;color:#e8e8f0;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer">
              <span class="mono" style="font-size:10px;color:#50506a">${prog}</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              ${!sec.isReflection?`<button onclick="event.stopPropagation();delWkSec(${si})" style="background:none;border:none;color:#50506a;font-size:12px;cursor:pointer;opacity:.5">‚úï</button>`:''}
              <span class="mono" style="font-size:11px;color:#50506a;transition:transform .25s;transform:${sec.open?'rotate(180deg)':'none'}">‚ñº</span>
            </div>
          </div>
          <div class="ws-body">${bodyHtml}</div>
        </div>`;
    }).join('');

    mainHtml = dayFilterHtml + `
      <div style="padding:0 14px">${sectionsHtml}</div>
      <div class="add-row">
        <input class="add-inp" id="newWkSecInp" placeholder="New category (e.g. Exercise)" onkeydown="if(event.key==='Enter')addWkSec()">
        <button class="btn-lime" onclick="addWkSec()" style="padding:0 16px;font-size:14px">+ Add</button>
      </div>`;
  }

  document.getElementById('page-weekly').innerHTML = `
    <div class="ph">
      <div class="mono" style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#64c8f5;display:block;margin-bottom:6px">üìÖ Weekly Planner</div>
      <div class="serif" style="font-size:26px;font-weight:700;line-height:1.2;display:block">Plan. Prepare.<br><em style="color:#c8f564">Show up all week.</em></div>
    </div>
    <div class="week-grid" style="margin-bottom:4px">${gridHtml}</div>
    <div style="padding:0 14px 16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <div class="mono" style="font-size:10px;color:#50506a">This week ¬∑ ${doneCount}/${totalCount} tasks</div>
        <div class="mono" style="font-size:11px;color:${weekPct===100?'#c8f564':weekPct>=70?'#64c8f5':'#8888a8'}">${weekPct}%</div>
      </div>
      <div style="height:4px;background:#20202d;border-radius:10px;overflow:hidden">
        <div style="height:100%;width:${weekPct}%;background:${weekPct===100?'#c8f564':'#64c8f5'};border-radius:10px;transition:width .4s"></div>
      </div>
    </div>
    ${tabHtml}
    ${mainHtml}`;
}

function setWeekTab(t) { weekTab=t; renderWeekly(); }
function filterByDay(d) { S.weeklyDayFilter=d; renderWeekly(); }
function toggleWkSec(si) { S.weekly[si].open=!S.weekly[si].open; debounceSave(); renderWeekly(); }
function toggleWkItem(si,ii) { S.weekly[si].items[ii].done=!S.weekly[si].items[ii].done; debounceSave(); renderWeekly(); }
function delWkItem(si,ii) { S.weekly[si].items.splice(ii,1); debounceSave(); renderWeekly(); }
function updateWkItemName(si,ii,val) { S.weekly[si].items[ii].text=val; debounceSave(); }
function updateWkSecName(si,val) { S.weekly[si].title=val; debounceSave(); }
function setWkItemDay(si,ii,val) { S.weekly[si].items[ii].day = val===''?undefined:parseInt(val); debounceSave(); renderWeekly(); }
function delWkSec(si) { if(!confirm('Delete this category?'))return; S.weekly.splice(si,1); debounceSave(); renderWeekly(); }

function addWkItem(si) {
  const inp = document.getElementById('wkai-'+si);
  const txt = inp?.value.trim();
  if (!txt) return;
  S.weekly[si].items.push({id:'i'+Date.now(),text:txt,done:false,reminder:'',day:undefined});
  inp.value=''; debounceSave(); renderWeekly(); toast('Task added ‚úì');
}
function addWkSec() {
  const inp = document.getElementById('newWkSecInp');
  const name = inp?.value.trim();
  if (!name) return;
  const icons = ['üìù','üèÉ','üßπ','üõí','üìû','üíº','üé®','üßò'];
  S.weekly.splice(S.weekly.length-1, 0, {key:'u'+Date.now(),title:name,icon:icons[S.weekly.length%icons.length],open:true,items:[],r1:'',r2:'',r3:''});
  inp.value=''; debounceSave(); renderWeekly(); toast(`"${name}" added ‚ú®`);
}
function saveWkRef(si) {
  S.weekly[si].r1 = document.getElementById(`wkref-${si}-r1`)?.value||'';
  S.weekly[si].r2 = document.getElementById(`wkref-${si}-r2`)?.value||'';
  S.weekly[si].r3 = document.getElementById(`wkref-${si}-r3`)?.value||'';
  debounceSave();
}
function saveWkRefBtn(si) { saveWkRef(si); toast('Review saved üåü'); }

// Weekly emoji picker
let wkEmojiFor = null;
function openWkEmojiPicker(si) {
  wkEmojiFor = si;
  const grid = document.getElementById('emojiGrid');
  grid.innerHTML = EMOJIS.map(em => `<button class="em-btn" onclick="pickWkEmoji('${em}')">${em}</button>`).join('');
  document.getElementById('emojiOverlay').classList.add('open');
}
function pickWkEmoji(em) {
  if (wkEmojiFor !== null) { S.weekly[wkEmojiFor].icon=em; debounceSave(); renderWeekly(); }
  wkEmojiFor = null;
  document.getElementById('emojiOverlay').classList.remove('open');
}

// Weekly item reminders
let wkRemSi, wkRemIi;
function openWkReminder(si,ii) {
  wkRemSi=si; wkRemIi=ii;
  const it = S.weekly[si].items[ii];
  document.getElementById('remName').textContent = it?.text||'';
  document.getElementById('remTime').value = it?.reminder||'08:00';
  document.getElementById('reminderOverlay').classList.add('open');
  // Override save to target weekly item
  window._reminderTarget = 'weekly';
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCHEDULE PAGE ‚Äî clean block-based design
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let schedView = 'day';
let schedDate = new Date();
let _editingBlockId = null;
let _blkDays = [];
let _blkColor = '#64c8f5';
let _blkCats = []; // selected category ids

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function toMins(hhmm) {
  if (!hhmm) return -1;
  const [h,m] = hhmm.split(':').map(Number);
  return h*60+m;
}
function fmtTime(hhmm) {
  if (!hhmm) return '';
  const [h,m] = hhmm.split(':').map(Number);
  const ampm = h<12?'am':'pm';
  const h12 = h%12||12;
  return m===0 ? h12+ampm : h12+':'+String(m).padStart(2,'0')+ampm;
}
function todayDateStr() { return new Date().toISOString().slice(0,10); }
function dateStr(d) { return d.toISOString().slice(0,10); }

// Get blocks for a given date
function getBlocksForDay(date) {
  const dayIdx = date.getDay();
  const ds = dateStr(date);
  return (S.schedBlocks||[]).filter(b => {
    if (b.type==='class'||b.type==='habit'||b.type==='sleep') return (b.days||[]).includes(dayIdx);
    if (b.type==='event'||b.type==='todo') return b.date===ds;
    return false;
  }).sort((a,b)=>toMins(a.start)-toMins(b.start));
}

// Get todos for a given date
function getTodosForDay(date) {
  const ds = dateStr(date);
  return (S.todos||[]).filter(t=>t.date===ds).sort((a,b)=>toMins(a.time)-toMins(b.time));
}

// Get habits that belong to a block (by category + auto-time-match)
function getHabitsForBlock(block) {
  const result = [];
  const startM = toMins(block.start);
  const endM = toMins(block.end||block.start);
  S.cats.forEach(cat => {
    const inCat = (block.cats||[]).includes(cat.id);
    cat.subs.forEach(sub => {
      const remM = toMins(sub.reminder);
      const autoMatch = sub.reminder && remM >= startM && remM <= endM;
      if (inCat || autoMatch) result.push({...sub, catName:cat.name, catIcon:cat.icon, catId:cat.id});
    });
  });
  return result;
}

// ‚îÄ‚îÄ RENDER SCHEDULE ‚îÄ‚îÄ
function renderSchedule() {
  const today = new Date();
  const isToday = schedDate.toDateString()===today.toDateString();
  const blocks = getBlocksForDay(schedDate);
  const todos = getTodosForDay(schedDate);

  const dateLabel = schedDate.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  const shortDays = ['S','M','T','W','T','F','S'];

  // Week strip for quick navigation
  const weekStart = new Date(schedDate); weekStart.setDate(schedDate.getDate()-schedDate.getDay());
  const weekStrip = Array.from({length:7},(_,i)=>{
    const d = new Date(weekStart); d.setDate(weekStart.getDate()+i);
    const sel = d.toDateString()===schedDate.toDateString();
    const isTod = d.toDateString()===today.toDateString();
    const hasBlocks = getBlocksForDay(d).length > 0;
    return `<div onclick="schedJump(${d.getTime()})" style="flex:1;text-align:center;padding:5px 2px;cursor:pointer">
      <div class="mono" style="font-size:8px;color:${sel?'#64c8f5':'#50506a'}">${shortDays[i]}</div>
      <div style="width:28px;height:28px;border-radius:50%;margin:2px auto;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;background:${sel?'#64c8f5':isTod?'rgba(100,200,245,.15)':'transparent'};color:${sel?'#0d0d0f':isTod?'#64c8f5':'#e8e8f0'}">${d.getDate()}</div>
      ${hasBlocks?`<div style="width:4px;height:4px;border-radius:50%;background:${sel?'#0d0d0f':'#64c8f5'};margin:0 auto"></div>`:'<div style="height:4px"></div>'}
    </div>`;
  }).join('');

  // Day timeline
  const HOUR_H = 72;
  const START_H = 5;
  const END_H = 24;
  const TOTAL = END_H - START_H;
  const totalPx = TOTAL * HOUR_H;

  let hoursHtml = '';
  for (let h=START_H; h<=END_H; h++) {
    const top = (h-START_H)*HOUR_H;
    const lbl = h===0?'12am':h<12?h+'am':h===12?'12pm':(h-12)+'pm';
    hoursHtml += `<div style="position:absolute;top:${top-8}px;left:0;width:44px;text-align:right;font-family:'DM Mono',monospace;font-size:9px;color:#383850;padding-right:6px">${lbl}</div>
    <div style="position:absolute;top:${top}px;left:44px;right:0;height:1px;background:#1a1a24"></div>`;
  }

  // Now line
  let nowHtml = '';
  if (isToday) {
    const now = new Date();
    const nowTop = ((now.getHours()+now.getMinutes()/60)-START_H)*HOUR_H;
    if (nowTop>=0 && nowTop<=totalPx) {
      nowHtml = `<div style="position:absolute;top:${nowTop}px;left:0;right:0;height:2px;background:#f564a9;z-index:10;pointer-events:none">
        <div style="position:absolute;left:38px;top:-4px;width:10px;height:10px;border-radius:50%;background:#f564a9"></div>
      </div>`;
    }
  }

  // Block rendering ‚Äî handle overlaps
  const positioned = blocks.map(b => ({
    ...b,
    startM: toMins(b.start),
    endM: toMins(b.end||b.start)+30,
    col: 0, cols: 1
  }));
  // Simple overlap detection
  positioned.forEach((b,i) => {
    positioned.slice(0,i).forEach(prev => {
      if (b.startM < prev.endM && b.endM > prev.startM) {
        b.col = prev.col+1;
        b.cols = Math.max(b.cols, b.col+1);
        prev.cols = Math.max(prev.cols, b.col+1);
      }
    });
  });

  const blocksHtml = positioned.map(b => {
    const topPx = (b.startM/60-START_H)*HOUR_H;
    const heightPx = Math.max(48, ((b.endM-b.startM)/60)*HOUR_H);
    if (topPx < 0 || topPx > totalPx) return '';
    const habits = b.type==='habit' ? getHabitsForBlock(b) : [];
    const doneCount = habits.filter(h=>h.done).length;
    const typeIcon = b.type==='class'?'üìö':b.type==='sleep'?'üò¥':b.type==='todo'?'‚úÖ':b.type==='event'?'üìå':'üå±';
    const colW = `calc((100% - ${b.cols>1?b.col*2:0}px) / ${b.cols})`;
    const colL = b.col > 0 ? `calc(${b.col} * (100% / ${b.cols}) + ${b.col*2}px)` : '0';
    const habitBadge = habits.length ? `<div style="font-family:'DM Mono',monospace;font-size:9px;margin-top:3px;opacity:.8">${doneCount}/${habits.length} ‚úì</div>` : '';
    return `<div onclick="openBlockDetail('${b.id}')"
      style="position:absolute;top:${topPx}px;left:calc(44px + ${colL});width:${colW};height:${heightPx}px;
        background:${b.color||'#64c8f5'}18;border-left:3px solid ${b.color||'#64c8f5'};
        border-radius:0 8px 8px 0;padding:6px 8px;cursor:pointer;overflow:hidden;
        transition:opacity .15s;box-sizing:border-box" 
      onmousedown="this.style.opacity='.7'" onmouseup="this.style.opacity='1'">
      <div style="font-size:11px;font-weight:700;color:${b.color||'#64c8f5'};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${typeIcon} ${b.title}</div>
      <div style="font-family:'DM Mono',monospace;font-size:9px;color:${b.color||'#64c8f5'};opacity:.7">${fmtTime(b.start)}${b.end?' ‚Äì '+fmtTime(b.end):''}</div>
      ${habitBadge}
    </div>`;
  }).join('');

  // Todos strip
  const todosHtml = todos.length ? `
    <div style="padding:0 14px;margin-bottom:12px">
      <div class="mono" style="font-size:10px;color:#50506a;letter-spacing:2px;text-transform:uppercase;display:block;margin-bottom:8px">To-Do</div>
      ${todos.map(t=>`
        <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:#14141a;border:1px solid ${t.done?'#262636':'#32324a'};border-radius:10px;margin-bottom:6px">
          <div onclick="toggleTodo('${t.id}')" style="width:20px;height:20px;border-radius:50%;border:2px solid ${t.done?'#c8f564':'#32324a'};background:${t.done?'#c8f564':'transparent'};display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;font-size:10px;color:#0d0d0f">${t.done?'‚úì':''}</div>
          <span style="flex:1;font-size:13px;font-weight:500;color:${t.done?'#50506a':'#e8e8f0'};text-decoration:${t.done?'line-through':'none'}">${esc(t.text)}${t.time?`<span style="font-family:'DM Mono',monospace;font-size:9px;color:#50506a;margin-left:6px">${fmtTime(t.time)}</span>`:''}</span>
          <div style="display:flex;gap:6px">
            <button onclick="moveTodoTomorrow('${t.id}')" title="Move to tomorrow" style="background:none;border:none;font-size:14px;cursor:pointer;opacity:.5">‚Üí</button>
            <button onclick="deleteTodo('${t.id}')" style="background:none;border:none;color:#f56464;font-size:12px;cursor:pointer;opacity:.5">‚úï</button>
          </div>
        </div>`).join('')}
    </div>` : '';

  document.getElementById('page-schedule').innerHTML = `
    <div style="position:sticky;top:0;z-index:50;background:#0d0d0f;border-bottom:1px solid #1a1a24">
      <div style="padding:44px 14px 8px;display:flex;align-items:center;justify-content:space-between">
        <button onclick="schedNav(-1)" style="background:#14141a;border:1px solid #262636;border-radius:10px;width:36px;height:36px;font-size:18px;color:#e8e8f0;cursor:pointer">‚Äπ</button>
        <div style="text-align:center">
          <div class="mono" style="font-size:9px;color:${isToday?'#64c8f5':'#50506a'};letter-spacing:2px;text-transform:uppercase">${isToday?'TODAY':''}</div>
          <div style="font-size:15px;font-weight:700">${schedDate.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</div>
        </div>
        <button onclick="schedNav(1)" style="background:#14141a;border:1px solid #262636;border-radius:10px;width:36px;height:36px;font-size:18px;color:#e8e8f0;cursor:pointer">‚Ä∫</button>
      </div>
      <div style="display:flex;padding:0 10px 8px">${weekStrip}</div>
    </div>

    ${todosHtml}

    <div style="position:relative;margin:0 6px;height:${totalPx}px">
      ${hoursHtml}${nowHtml}${blocksHtml}
    </div>
    <div style="height:80px"></div>

    <div style="position:fixed;bottom:80px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:100">
      <button onclick="openTodoSheet()" style="width:44px;height:44px;border-radius:50%;background:#1a1a24;border:1px solid #262636;font-size:18px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.4)">‚úÖ</button>
      <button onclick="openBlockSheet()" style="width:52px;height:52px;border-radius:50%;background:#c8f564;border:none;font-size:22px;font-weight:700;color:#0d0d0f;cursor:pointer;box-shadow:0 4px 16px rgba(200,245,100,.3)">+</button>
    </div>`;

  // Auto-scroll to now
  if (isToday) {
    setTimeout(()=>{
      const nowEl = document.querySelector('#page-schedule [style*="background:#f564a9"]');
      if (nowEl) nowEl.scrollIntoView({behavior:'smooth',block:'center'});
      else { const top = ((new Date().getHours()-2)*HOUR_H); document.getElementById('page-schedule').scrollTop = top; }
    }, 150);
  }
}

function schedNav(dir) { schedDate.setDate(schedDate.getDate()+dir); renderSchedule(); }
function schedJump(ts) { schedDate = new Date(ts); renderSchedule(); }

// ‚îÄ‚îÄ Block detail sheet (tap block) ‚îÄ‚îÄ
function openBlockDetail(blockId) {
  const block = (S.schedBlocks||[]).find(b=>b.id===blockId);
  if (!block) return;
  const habits = block.type==='habit' ? getHabitsForBlock(block) : [];
  const todos = block.type==='todo' ? getTodosForDay(schedDate) : [];
  const typeIcon = block.type==='class'?'üìö':block.type==='sleep'?'üò¥':block.type==='todo'?'‚úÖ':block.type==='event'?'üìå':'üå±';

  let bodyHtml = '';

  if (block.type === 'habit' && habits.length) {
    // Group by category
    const byCat = {};
    habits.forEach(h => {
      if (!byCat[h.catId]) byCat[h.catId] = {name:h.catName, icon:h.catIcon, habits:[]};
      byCat[h.catId].habits.push(h);
    });
    bodyHtml = Object.values(byCat).map(cat => `
      <div style="margin-bottom:14px">
        <div style="font-size:12px;font-weight:700;color:#8888a8;margin-bottom:8px;display:flex;align-items:center;gap:6px">
          <span>${cat.icon}</span>${cat.name}
        </div>
        ${cat.habits.map(h=>`
          <div onclick="toggleSubFromSched(${h.catId},${h.id})" style="display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid #1a1a24;cursor:pointer">
            <div style="width:24px;height:24px;border-radius:50%;border:2px solid ${h.done?block.color||'#64c8f5':'#32324a'};background:${h.done?block.color||'#64c8f5':'transparent'};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:11px;color:#0d0d0f;transition:all .2s">${h.done?'‚úì':''}</div>
            <div style="flex:1">
              <div style="font-size:14px;font-weight:500;color:${h.done?'#50506a':'#e8e8f0'};text-decoration:${h.done?'line-through':'none'}">${esc(h.name)}</div>
              ${h.streak>0?`<div class="mono" style="font-size:9px;color:#f5c842;margin-top:2px">üî• ${h.streak} day streak</div>`:''}
            </div>
          </div>`).join('')}
      </div>`).join('');
  } else if (block.type === 'habit' && !habits.length) {
    bodyHtml = `<div style="text-align:center;padding:20px 0;color:#50506a;font-size:13px">No habits attached yet.<br><span style="font-size:11px">Edit this block to add habit categories.</span></div>`;
  } else if (block.type === 'class' || block.type === 'event') {
    bodyHtml = `<div style="background:#14141a;border-radius:12px;padding:14px;margin-bottom:14px">
      <div class="mono" style="font-size:10px;color:#50506a">Type: ${block.type==='class'?'Repeating class':'One-off event'}</div>
      ${block.days?.length?`<div class="mono" style="font-size:10px;color:#50506a;margin-top:4px">Repeats: ${['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].filter((_,i)=>block.days.includes(i)).join(', ')}</div>`:''}
    </div>`;
  } else if (block.type === 'sleep') {
    bodyHtml = `<div style="text-align:center;padding:20px;font-size:40px">üò¥</div>`;
  }

  const doneCount = habits.filter(h=>h.done).length;
  const pct = habits.length ? Math.round(doneCount/habits.length*100) : 0;

  document.getElementById('blockDetailContent').innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <div>
        <div style="font-size:18px;font-weight:700;color:${block.color||'#64c8f5'}">${typeIcon} ${block.title}</div>
        <div class="mono" style="font-size:11px;color:#50506a">${fmtTime(block.start)}${block.end?' ‚Äì '+fmtTime(block.end):''}</div>
      </div>
      <button onclick="closeBlockDetail();openBlockSheet('${block.id}')" style="background:#14141a;border:1px solid #262636;border-radius:8px;padding:6px 10px;color:#8888a8;font-size:12px;cursor:pointer">Edit</button>
    </div>
    ${habits.length?`
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <div class="mono" style="font-size:10px;color:#50506a">${doneCount}/${habits.length} complete</div>
        <div class="mono" style="font-size:10px;color:${pct===100?block.color||'#64c8f5':'#50506a'}">${pct}%</div>
      </div>
      <div style="height:4px;background:#1a1a24;border-radius:10px;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${block.color||'#64c8f5'};border-radius:10px;transition:width .4s"></div>
      </div>
    </div>`:''}
    ${bodyHtml}
    <button onclick="closeBlockDetail()" style="display:block;width:100%;padding:11px;background:none;border:none;color:#50506a;font-size:14px;cursor:pointer;margin-top:8px">Close</button>`;

  document.getElementById('blockDetailSheet').classList.add('open');
}

function closeBlockDetail() { document.getElementById('blockDetailSheet').classList.remove('open'); }

function toggleSubFromSched(catId, subId) {
  const cat = S.cats.find(c=>c.id===catId);
  const sub = cat?.subs.find(s=>s.id===subId);
  if (sub) { sub.done=!sub.done; debounceSave(); }
  // Re-render detail sheet with updated state
  const detailEl = document.getElementById('blockDetailSheet');
  if (detailEl.classList.contains('open')) {
    const blockId = detailEl.querySelector('[onclick^="closeBlockDetail"]')?.getAttribute('data-block');
    // Just re-open current block
    const openBtn = detailEl.querySelector('button[onclick^="closeBlockDetail;openBlockSheet"]');
    if (openBtn) {
      const match = openBtn.getAttribute('onclick').match(/'([^']+)'/);
      if (match) openBlockDetail(match[1]);
    }
  }
  renderSchedule();
}

// ‚îÄ‚îÄ Block creation / edit ‚îÄ‚îÄ
function openBlockSheet(editId) {
  _editingBlockId = editId||null;
  _blkDays = [];
  _blkColor = '#64c8f5';
  _blkCats = [];

  const b = editId ? (S.schedBlocks||[]).find(x=>x.id===editId) : null;
  document.getElementById('blockSheetTitle').textContent = b ? 'Edit Block' : 'New Block';
  document.getElementById('blkTitle').value = b?.title||'';
  document.getElementById('blkType').value = b?.type||'habit';
  document.getElementById('blkStart').value = b?.start||'07:30';
  document.getElementById('blkEnd').value = b?.end||'08:30';
  document.getElementById('blkReminder').value = b?.reminder||10;
  document.getElementById('blkDate').value = b?.date||dateStr(schedDate);
  document.getElementById('blkSaveBtn').textContent = b ? 'Save Changes ‚úì' : 'Add Block ‚úì';
  document.getElementById('blkDeleteBtn').style.display = b ? 'block' : 'none';

  if (b?.days) _blkDays=[...b.days];
  if (b?.color) _blkColor=b.color;
  if (b?.cats) _blkCats=[...b.cats];

  // Day picker
  document.querySelectorAll('.day-pick-btn').forEach(btn=>{
    btn.classList.toggle('active',_blkDays.includes(parseInt(btn.dataset.day)));
  });
  // Color picker
  document.querySelectorAll('.col-pick').forEach(el=>{
    el.classList.toggle('active',el.dataset.color===_blkColor);
  });
  // Category picker
  const catPicker = document.getElementById('blkCatPicker');
  catPicker.innerHTML = S.cats.map(cat=>`
    <div onclick="toggleBlkCat(${cat.id})" id="blkcat-${cat.id}"
      style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:${_blkCats.includes(cat.id)?'rgba(100,200,245,.08)':'#14141a'};border:1px solid ${_blkCats.includes(cat.id)?'#64c8f5':'#262636'};border-radius:10px;cursor:pointer;transition:all .2s">
      <span style="font-size:18px">${cat.icon}</span>
      <span style="font-size:13px;font-weight:500;flex:1">${esc(cat.name)}</span>
      <span style="color:${_blkCats.includes(cat.id)?'#64c8f5':'#50506a'};font-size:14px">${_blkCats.includes(cat.id)?'‚úì':'+'}</span>
    </div>`).join('');

  updateBlkTypeUI();
  document.getElementById('blockSheet').classList.add('open');
}

function closeBlockSheet() { document.getElementById('blockSheet').classList.remove('open'); }

function toggleBlkDay(d) {
  const i=_blkDays.indexOf(d);
  if(i===-1)_blkDays.push(d); else _blkDays.splice(i,1);
  document.querySelectorAll('.day-pick-btn').forEach(btn=>btn.classList.toggle('active',_blkDays.includes(parseInt(btn.dataset.day))));
}
function toggleBlkCat(id) {
  const i=_blkCats.indexOf(id);
  if(i===-1)_blkCats.push(id); else _blkCats.splice(i,1);
  const el=document.getElementById('blkcat-'+id);
  if(el){
    el.style.background=_blkCats.includes(id)?'rgba(100,200,245,.08)':'#14141a';
    el.style.borderColor=_blkCats.includes(id)?'#64c8f5':'#262636';
    el.querySelector('span:last-child').textContent=_blkCats.includes(id)?'‚úì':'+';
    el.querySelector('span:last-child').style.color=_blkCats.includes(id)?'#64c8f5':'#50506a';
  }
}
function pickBlkColor(c) {
  _blkColor=c;
  document.querySelectorAll('.col-pick').forEach(el=>el.classList.toggle('active',el.dataset.color===c));
}
function updateBlkTypeUI() {
  const t=document.getElementById('blkType').value;
  document.getElementById('blkRepeatRow').style.display=(t==='class'||t==='habit'||t==='sleep')?'block':'none';
  document.getElementById('blkDateRow').style.display=(t==='event'||t==='todo')?'block':'none';
  document.getElementById('blkHabitSection').style.display=(t==='habit')?'block':'none';
}

function saveBlock() {
  const title=document.getElementById('blkTitle').value.trim();
  if(!title){toast('Add a name first');return;}
  const type=document.getElementById('blkType').value;
  const start=document.getElementById('blkStart').value;
  const end=document.getElementById('blkEnd').value;
  const reminder=parseInt(document.getElementById('blkReminder').value)||0;
  const date=document.getElementById('blkDate').value;
  if(!S.schedBlocks) S.schedBlocks=[];
  const blockData={title,type,start,end,reminder,color:_blkColor,
    days:(type==='class'||type==='habit'||type==='sleep')?[..._blkDays]:undefined,
    date:(type==='event'||type==='todo')?date:undefined,
    cats:(type==='habit')?[..._blkCats]:undefined};
  if(_editingBlockId){
    const idx=S.schedBlocks.findIndex(b=>b.id===_editingBlockId);
    if(idx!==-1) S.schedBlocks[idx]={...S.schedBlocks[idx],...blockData};
    toast('Block updated ‚úì');
  } else {
    S.schedBlocks.push({id:'blk_'+Date.now(),...blockData});
    toast('Block added ‚úì');
  }
  closeBlockSheet();
  debounceSave();
  renderSchedule();
  requestNotifPermission();
}

function deleteBlock() {
  if(!confirm('Delete this block?'))return;
  S.schedBlocks=(S.schedBlocks||[]).filter(b=>b.id!==_editingBlockId);
  closeBlockSheet();
  debounceSave();
  renderSchedule();
  toast('Deleted');
}

// ‚îÄ‚îÄ TO-DO SYSTEM ‚îÄ‚îÄ
function openTodoSheet() {
  document.getElementById('todoInp').value='';
  document.getElementById('todoTime').value='';
  document.getElementById('todoSheet').classList.add('open');
  setTimeout(()=>document.getElementById('todoInp').focus(),300);
}
function closeTodoSheet() { document.getElementById('todoSheet').classList.remove('open'); }

function saveTodo() {
  const text=document.getElementById('todoInp').value.trim();
  if(!text){toast('Add a task first');return;}
  const dayVal=document.getElementById('todoDay').value;
  const time=document.getElementById('todoTime').value||'';
  const d=new Date();
  if(dayVal==='tomorrow') d.setDate(d.getDate()+1);
  else if(dayVal!=='today'){
    const days=['sun','mon','tue','wed','thu','fri','sat'];
    const target=days.indexOf(dayVal);
    const diff=(target-d.getDay()+7)%7||7;
    d.setDate(d.getDate()+diff);
  }
  if(!S.todos) S.todos=[];
  S.todos.push({id:'td_'+Date.now(),text,date:dateStr(d),time,done:false,created:Date.now()});
  closeTodoSheet();
  debounceSave();
  renderSchedule();
  renderToday();
  toast('To-do added ‚úì');
}

function toggleTodo(id) {
  const t=(S.todos||[]).find(x=>x.id===id);
  if(t){t.done=!t.done;debounceSave();renderSchedule();renderToday();}
}
function deleteTodo(id) {
  S.todos=(S.todos||[]).filter(x=>x.id!==id);
  debounceSave();renderSchedule();renderToday();toast('Removed');
}
function moveTodoTomorrow(id) {
  const t=(S.todos||[]).find(x=>x.id===id);
  if(!t)return;
  const d=new Date(t.date+'T12:00:00'); d.setDate(d.getDate()+1);
  t.date=dateStr(d); t.done=false;
  debounceSave();renderSchedule();renderToday();toast('Moved to tomorrow ‚Üí');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOURNAL / MIND PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activePrompt = 'What am I proud of today?';
let journalTab = 'journal';

function renderJournal() {
  const tabs = ['journal','identity','goals','struggles'];
  const tabsHtml = tabs.map(t => `<button class="hub-tab${journalTab===t?' active':''}" onclick="switchJournalTab('${t}')">${t.charAt(0).toUpperCase()+t.slice(1)}</button>`).join('');

  let panelHtml = '';
  if (journalTab === 'journal') panelHtml = renderJournalPanel();
  else if (journalTab === 'identity') panelHtml = renderIdentityPanel();
  else if (journalTab === 'goals') panelHtml = renderGoalsPanel();
  else if (journalTab === 'struggles') panelHtml = renderStrugglesPanel();

  document.getElementById('page-journal').innerHTML = `
    <div class="ph">
      <div class="mono" style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#f564a9;display:block;margin-bottom:6px">üìì Mind & Identity</div>
      <div class="serif" style="font-size:26px;font-weight:700;line-height:1.2;display:block">Your inner world,<br><em style="color:#c8f564">organized.</em></div>
    </div>
    <div class="hub-tabs">${tabsHtml}</div>
    <div class="hub-panel active">${panelHtml}</div>`;
}

function switchJournalTab(t) { journalTab = t; renderJournal(); }

const PROMPTS = ['What am I proud of today?','What challenged me?','Who am I becoming?','What do I want to release?','Tomorrow I intend to‚Ä¶','I am grateful for‚Ä¶','How did I show up for myself?'];
const PROMPT_LABELS = ['Proud of','Challenge','Identity','Release','Tomorrow','Grateful','Self-care'];

function renderJournalPanel() {
  const chipsHtml = PROMPTS.map((p,i) => `<button class="p-chip${activePrompt===p?' active':''}" onclick="setPrompt('${p.replace(/'/g,"\\'")}',this)">${PROMPT_LABELS[i]}</button>`).join('');
  const entriesHtml = S.entries.slice(0,12).map(e => `
    <div class="entry-card">
      <div class="mono" style="font-size:9px;color:#50506a;margin-bottom:4px">${e.date}</div>
      <div class="mono" style="font-size:10px;color:#f564a9;margin-bottom:5px">${esc(e.prompt)}</div>
      <div class="serif" style="font-size:14px;font-style:italic;color:#8888a8;line-height:1.6">${esc(e.text.slice(0,200))}${e.text.length>200?'‚Ä¶':''}</div>
    </div>`).join('');
  return `
    <div class="prompt-chips">${chipsHtml}</div>
    <div class="mono" id="jPromptLbl" style="font-size:10px;color:#f564a9;display:block;margin-bottom:8px">${esc(activePrompt)}</div>
    <textarea class="j-ta" id="jText" placeholder="Write freely‚Ä¶ your thoughts are safe here."></textarea>
    <button class="btn-save" onclick="saveJEntry()" style="background:linear-gradient(135deg,#f564a9,#a064f5);color:#fff">Save Entry ‚ú®</button>
    ${S.entries.length ? `<div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:10px">Past Entries</div>${entriesHtml}` : ''}`;
}

function setPrompt(p, el) {
  activePrompt = p;
  document.querySelectorAll('.p-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  const lbl = document.getElementById('jPromptLbl');
  if (lbl) lbl.textContent = p;
}
function saveJEntry() {
  const txt = document.getElementById('jText')?.value.trim();
  if (!txt) { toast('Write something üìù'); return; }
  S.entries.unshift({date:new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),prompt:activePrompt,text:txt,ts:Date.now()});
  if (S.entries.length > 100) S.entries.pop();
  debounceSave(); renderJournal(); toast('Entry saved ‚ú®');
}

function renderIdentityPanel() {
  const id = S.identity;
  return `
    <div class="id-card">
      <div class="mono" style="font-size:9px;letter-spacing:2px;color:#c8f564;text-transform:uppercase;display:block;margin-bottom:8px">‚ö° My Identity Statement</div>
      <textarea class="id-ta" id="idStmt" rows="3" placeholder="I am someone who shows up for herself every single day‚Ä¶">${esc(id.statement||'')}</textarea>
    </div>
    <div class="pillars-grid">
      <div class="pillar-card"><div class="mono" style="font-size:9px;letter-spacing:1px;color:#c8f564;text-transform:uppercase;display:block;margin-bottom:7px">üí™ My Values</div><textarea class="pillar-ta" id="idValues" rows="4" placeholder="Discipline, growth‚Ä¶">${esc(id.values||'')}</textarea></div>
      <div class="pillar-card"><div class="mono" style="font-size:9px;letter-spacing:1px;color:#64c8f5;text-transform:uppercase;display:block;margin-bottom:7px">üå± Growing into‚Ä¶</div><textarea class="pillar-ta" id="idGrowing" rows="4" placeholder="Confident, focused‚Ä¶">${esc(id.growing||'')}</textarea></div>
      <div class="pillar-card"><div class="mono" style="font-size:9px;letter-spacing:1px;color:#f564a9;text-transform:uppercase;display:block;margin-bottom:7px">üíñ I love about me‚Ä¶</div><textarea class="pillar-ta" id="idLove" rows="4" placeholder="My resilience‚Ä¶">${esc(id.love||'')}</textarea></div>
      <div class="pillar-card"><div class="mono" style="font-size:9px;letter-spacing:1px;color:#f5c842;text-transform:uppercase;display:block;margin-bottom:7px">üîë Releasing‚Ä¶</div><textarea class="pillar-ta" id="idRelease" rows="4" placeholder="Self-doubt‚Ä¶">${esc(id.release||'')}</textarea></div>
    </div>
    <button class="btn-save" onclick="saveIdentity()" style="background:linear-gradient(135deg,#c8f564,#64c8f5);color:#0d0d0f">Save Identity ‚ö°</button>`;
}
function saveIdentity() {
  S.identity = {
    statement: document.getElementById('idStmt')?.value||'',
    values: document.getElementById('idValues')?.value||'',
    growing: document.getElementById('idGrowing')?.value||'',
    love: document.getElementById('idLove')?.value||'',
    release: document.getElementById('idRelease')?.value||''
  };
  debounceSave(); toast('Identity saved ‚ö°');
}

function renderGoalsPanel() {
  const goalsHtml = S.goals.map((g,i) => `
    <div class="goal-card">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <span class="g-badge ${g.type==='short'?'gs':'gl'}">${g.type==='short'?'This Month':'Long-term'}</span>
        <input class="g-title-inp" value="${esc(g.title)}" placeholder="Goal title‚Ä¶" onchange="updateGoal(${i},'title',this.value)">
        <button onclick="delGoal(${i})" style="background:none;border:none;color:#50506a;cursor:pointer;font-size:12px">‚úï</button>
      </div>
      <input class="g-why-inp" value="${esc(g.why)}" placeholder="Why this matters‚Ä¶" onchange="updateGoal(${i},'why',this.value)">
      <div class="g-pb"><div class="g-pf" id="gpf-${i}" style="width:${g.pct}%"></div></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:7px">
        <span class="mono" style="font-size:10px;color:#50506a" id="gpct-${i}">${g.pct}% complete</span>
        <input type="range" min="0" max="100" value="${g.pct}" style="width:80px;accent-color:#c8f564" oninput="updateGoalPct(${i},this.value)">
      </div>
    </div>`).join('');
  return `
    <button onclick="addGoal('short')" style="display:flex;align-items:center;gap:8px;padding:11px 14px;background:#14141a;border:1px dashed #32324a;border-radius:12px;cursor:pointer;color:#50506a;font-size:12px;font-family:'DM Mono',monospace;width:100%;margin-bottom:10px">+ Short-term goal (this month)</button>
    <button onclick="addGoal('long')" style="display:flex;align-items:center;gap:8px;padding:11px 14px;background:#14141a;border:1px dashed rgba(160,100,245,.3);border-radius:12px;cursor:pointer;color:#a064f5;font-size:12px;font-family:'DM Mono',monospace;width:100%;margin-bottom:14px">+ Long-term goal (this year)</button>
    ${S.goals.length===0?'<div class="mono" style="font-size:11px;color:#50506a;text-align:center;padding:20px">Add your first goal above ‚Üë</div>':''}
    ${goalsHtml}`;
}
function addGoal(type) { S.goals.push({id:Date.now(),type,title:'',why:'',pct:0}); debounceSave(); renderJournal(); }
function updateGoal(i,k,v) { S.goals[i][k]=v; debounceSave(); }
function updateGoalPct(i,v) {
  S.goals[i].pct = +v;
  const pf = document.getElementById('gpf-'+i);
  const pc = document.getElementById('gpct-'+i);
  if (pf) pf.style.width = v+'%';
  if (pc) pc.textContent = v+'% complete';
  debounceSave();
}
function delGoal(i) { S.goals.splice(i,1); debounceSave(); renderJournal(); }

function renderStrugglesPanel() {
  const strHtml = S.struggles.slice(0,8).map(s => `
    <div class="str-card">
      <div class="mono" style="font-size:9px;color:#50506a;margin-bottom:4px">${s.date}</div>
      <div style="font-size:13px;color:#8888a8;line-height:1.6">${esc(s.text)}</div>
      ${s.reframe?`<div class="serif" style="font-size:12px;color:#f5c842;margin-top:5px;font-style:italic">Reframe: ${esc(s.reframe)}</div>`:''}
    </div>`).join('');
  return `
    <div class="mono" style="font-size:10px;color:#f5c842;display:block;margin-bottom:8px">What am I struggling with?</div>
    <textarea class="str-inp" id="strText" placeholder="Be honest ‚Äî this is just for you."></textarea>
    <div class="mono" style="font-size:10px;color:#f5c842;display:block;margin-bottom:8px">Reframe it‚Ä¶</div>
    <textarea class="str-rf-inp" id="strRf" placeholder="Even though it's hard, I know that‚Ä¶"></textarea>
    <button class="btn-save" onclick="saveStruggle()" style="background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.3);color:#f5c842">Log it üå±</button>
    ${S.struggles.length?`<div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:10px">Past Struggles & Reframes</div>${strHtml}`:''}`;
}
function saveStruggle() {
  const txt = document.getElementById('strText')?.value.trim();
  if (!txt) { toast('Describe it üå±'); return; }
  const rf = document.getElementById('strRf')?.value.trim();
  S.struggles.unshift({date:new Date().toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),text:txt,reframe:rf,ts:Date.now()});
  if (S.struggles.length > 50) S.struggles.pop();
  debounceSave(); renderJournal(); toast('Logged üå±');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROGRESS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let progressPeriod = 30;
function renderProgress() {
  const allSubs = S.cats.flatMap(c=>c.subs);
  const totalDone = allSubs.reduce((a,s)=>a+(s.totalDone||0),0);
  const maxStreak = Math.max(...allSubs.map(s=>s.streak||0),0);
  const perfectDays = S.perfectDays||0;
  const history = S.dayHistory||{};
  const histVals = Object.values(history);
  const avgPct = histVals.length ? Math.round(histVals.reduce((a,b)=>a+b,0)/histVals.length) : 0;

  const periodTabsHtml = [30,60,90,365].map(d => `<button class="ppt${progressPeriod===d?' active':''}" onclick="setProgressPeriod(${d})">${d===365?'All Time':d+' Days'}</button>`).join('');

  const overviewHtml = [
    {n:totalDone,l:'Total Completions',s:'all time',c:'#c8f564'},
    {n:maxStreak,l:'Best Streak',s:'current',c:'#f5c842'},
    {n:perfectDays,l:'Perfect Days',s:'100% complete',c:'#f564a9'},
    {n:avgPct+'%',l:'Avg Completion',s:`${histVals.length} days tracked`,c:'#64c8f5'},
  ].map(item => `
    <div class="po-card">
      <div class="serif" style="font-size:28px;font-weight:700;color:${item.c};line-height:1;display:block">${item.n}</div>
      <div class="mono" style="font-size:9px;color:#50506a;text-transform:uppercase;letter-spacing:1px;display:block;margin-top:4px">${item.l}</div>
      <div class="mono" style="font-size:10px;color:#8888a8;display:block;margin-top:2px">${item.s}</div>
    </div>`).join('');

  // Heatmap ‚Äî last 84 days
  const today = new Date();
  const heatHtml = Array.from({length:84},(_,i)=>{
    const d = new Date(today); d.setDate(today.getDate()-(83-i));
    const key = d.toDateString();
    const pct = history[key]||(key===today.toDateString()?calcPct():0);
    const lvl = pct>=100?'l4':pct>=75?'l3':pct>=50?'l2':pct>0?'l1':'';
    return `<div class="hm-cell${lvl?' '+lvl:''}" style="width:calc((100% - 3px*20)/21);aspect-ratio:1" title="${pct}%"></div>`;
  }).join('');

  const COLORS = ['#c8f564','#64c8f5','#f564a9','#f5c842','#a064f5','#64f5b8'];
  const catProgressHtml = S.cats.map((cat,i) => {
    const catTotal = cat.subs.reduce((a,s)=>a+(s.totalDone||0),0);
    const bestStr = Math.max(...cat.subs.map(s=>s.bestStreak||0),0);
    const curStr = Math.max(...cat.subs.map(s=>s.streak||0),0);
    const c = COLORS[i%COLORS.length];
    return `
      <div class="cp-card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
          <div style="font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:#1a1a24;border-radius:10px;flex-shrink:0">${cat.icon}</div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:600">${esc(cat.name)}</div>
            <div class="mono" style="font-size:10px;color:#50506a">${cat.subs.length} habits ¬∑ ${cat.subs.filter(s=>s.done).length} done today</div>
          </div>
          <div class="serif" style="font-size:22px;font-weight:700;color:${c}">${catTotal}</div>
        </div>
        <div style="height:6px;background:#20202d;border-radius:10px;overflow:hidden;margin-bottom:10px">
          <div style="height:100%;width:${Math.min(catTotal>0?80:0,100)}%;background:${c};border-radius:10px;transition:width .6s"></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          ${[{n:catTotal,l:'All-time ‚úì',c},{n:curStr+'d',l:'Streak',c:'#f5c842'},{n:bestStr+'d',l:'Best Streak',c:'#64c8f5'}].map(st=>`
            <div style="background:#1a1a24;border:1px solid #262636;border-radius:8px;padding:6px 10px">
              <div class="serif" style="font-size:16px;font-weight:700;color:${st.c};display:block">${st.n}</div>
              <div class="mono" style="font-size:8px;color:#50506a;text-transform:uppercase;letter-spacing:.5px">${st.l}</div>
            </div>`).join('')}
        </div>
      </div>`;
  }).join('');

  document.getElementById('page-progress').innerHTML = `
    <div class="ph">
      <div class="mono" style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#64f5b8;display:block;margin-bottom:6px">üìà Long-Term Progress</div>
      <div class="serif" style="font-size:26px;font-weight:700;line-height:1.2;display:block">Every day adds up.<br><em style="color:#c8f564">Watch yourself grow.</em></div>
    </div>
    <div class="period-tabs">${periodTabsHtml}</div>
    <div class="prog-overview">${overviewHtml}</div>
    <div style="padding:0 14px;margin-bottom:20px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:12px">Activity Heatmap (Last 3 Months)</div>
      <div style="background:#14141a;border:1px solid #262636;border-radius:14px;padding:14px">
        <div class="heatmap">${heatHtml}</div>
        <div style="display:flex;align-items:center;gap:4px;margin-top:10px;justify-content:flex-end">
          <span class="mono" style="font-size:9px;color:#50506a">Less</span>
          <div style="width:12px;height:12px;border-radius:2px;background:#20202d"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(200,245,100,.2)"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(200,245,100,.45)"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:rgba(200,245,100,.7)"></div>
          <div style="width:12px;height:12px;border-radius:2px;background:#c8f564"></div>
          <span class="mono" style="font-size:9px;color:#50506a">More</span>
        </div>
      </div>
    </div>
    <div style="padding:0 14px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:12px">By Category</div>
      ${catProgressHtml}
    </div>`;
}
function setProgressPeriod(d) { progressPeriod=d; renderProgress(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRIENDS PAGE  (reads leaderboard from Supabase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lbMode = 'streak';

async function renderFriends() {
  const uid = currentUser.id;
  const profile = LS.get('glowup_profile_' + uid) || {};
  const myCode = profile.friend_code || genCode(currentUser.email || uid);
  const myName = profile.display_name || currentUser.email?.split('@')[0] || 'You';
  const allSubs = S.cats.flatMap(c=>c.subs);
  const myStreak = Math.max(...allSubs.map(s=>s.streak||0),0);
  const myPct = calcPct();
  const myPerfect = S.perfectDays||0;

  // Render shell immediately with my data
  const medals = ['ü•á','ü•à','ü•â'];
  const lbColors = ['#c8f564','#64c8f5','#f564a9','#f5c842','#a064f5','#64f5b8'];

  const lbTabsHtml = [['streak','üî• Streak'],['perfect','üíé Perfect Days'],['today','‚ú¶ Today']].map(([m,l]) =>
    `<button class="mono" onclick="setLbMode('${m}')" style="padding:6px 12px;background:${lbMode===m?'rgba(245,200,66,.06)':'#14141a'};border:1px solid ${lbMode===m?'#f5c842':'#262636'};border-radius:16px;font-size:10px;color:${lbMode===m?'#f5c842':'#50506a'};cursor:pointer">${l}</button>`
  ).join('');

  document.getElementById('page-friends').innerHTML = `
    <div class="ph">
      <div class="mono" style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#f5c842;display:block;margin-bottom:6px">üèÜ Accountability</div>
      <div class="serif" style="font-size:26px;font-weight:700;line-height:1.2;display:block">Compete. Encourage.<br><em style="color:#c8f564">Win together.</em></div>
    </div>
    <div class="share-card">
      <div style="font-size:14px;font-weight:700;margin-bottom:6px">Your Friend Code üîó</div>
      <div class="mono" style="font-size:10px;color:#8888a8;line-height:1.6;display:block;margin-bottom:12px">Share your code ‚Äî your friend enters it to join your leaderboard. Works across any device, anywhere.</div>
      <div class="code-box">
        <span class="mono" style="flex:1;font-size:18px;color:#f5c842;letter-spacing:4px;font-weight:500">${myCode}</span>
        <button onclick="copyCode('${myCode}')" style="background:#f5c842;color:#0d0d0f;border:none;border-radius:8px;padding:6px 12px;font-family:'DM Mono',monospace;font-size:11px;font-weight:500;cursor:pointer">Copy</button>
      </div>
      <button onclick="nativeShare('${myCode}','${esc(myName)}')" style="display:block;width:100%;padding:11px;background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.25);color:#f5c842;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer">üì§ Share via Messages / WhatsApp</button>
    </div>
    <div style="padding:0 14px;margin-bottom:20px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:12px">Leaderboard</div>
      <div style="display:flex;gap:6px;margin-bottom:14px">${lbTabsHtml}</div>
      <div class="lb-card" id="lbCard"><div class="mono" style="font-size:11px;color:#50506a;padding:20px;text-align:center">Loading‚Ä¶</div></div>
    </div>
    <div style="padding:0 14px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:10px">Add Friend by Code</div>
      <div style="display:flex;gap:10px">
        <input id="friendCodeInp" class="add-inp" placeholder="Enter friend's code (e.g. GLWMAYA)" style="font-family:'DM Mono',monospace;letter-spacing:1px;text-transform:uppercase" onkeydown="if(event.key==='Enter')addFriend()">
        <button class="btn-lime" onclick="addFriend()" style="padding:0 16px;font-size:14px;flex-shrink:0">Add</button>
      </div>
    </div>`;

  // Now fetch leaderboard from Supabase async
  const friendCodes = S.friends || [];
  const allCodes = [myCode, ...friendCodes];

  const { data: lbRows } = await sb
    .from('leaderboard')
    .select('*')
    .in('friend_code', allCodes);

  const entries = lbRows ? lbRows.map(row => ({
    name: row.display_name,
    code: row.friend_code,
    streak: row.streak || 0,
    pct: row.today_pct || 0,
    perfect: row.perfect_days || 0,
    you: row.friend_code === myCode
  })) : [{name:myName,code:myCode,streak:myStreak,pct:myPct,perfect:myPerfect,you:true}];

  // Make sure "me" is always in the list
  if (!entries.find(e=>e.you)) {
    entries.push({name:myName,code:myCode,streak:myStreak,pct:myPct,perfect:myPerfect,you:true});
  }

  if (lbMode==='streak') entries.sort((a,b)=>b.streak-a.streak);
  else if (lbMode==='perfect') entries.sort((a,b)=>b.perfect-a.perfect);
  else entries.sort((a,b)=>b.pct-a.pct);

  const lbEl = document.getElementById('lbCard');
  if (!lbEl) return;

  if (entries.length === 1 && entries[0].you) {
    lbEl.innerHTML = `
      <div style="padding:20px;text-align:center">
        <div style="font-size:22px;margin-bottom:8px">üèÜ</div>
        <div style="font-size:13px;font-weight:600;margin-bottom:6px">You're first on the board!</div>
        <div class="mono" style="font-size:10px;color:#50506a">Add a friend using their code below to compete.</div>
      </div>`;
    return;
  }

  lbEl.innerHTML = entries.map((p,i) => {
    const score = lbMode==='streak'?`üî•${p.streak}d`:lbMode==='perfect'?`üíé${p.perfect}`:`${Math.round(p.pct)}%`;
    const top = entries[0];
    const barPct = top ? (lbMode==='streak'?p.streak/Math.max(top.streak,1):lbMode==='perfect'?p.perfect/Math.max(top.perfect,1):p.pct/100)*100 : 0;
    return `
      <div class="lb-row${p.you?' you':''}">
        <div class="mono" style="font-size:14px;width:22px;text-align:center;flex-shrink:0">${medals[i]||i+1}</div>
        <span style="font-size:20px;flex-shrink:0">${p.you?'üåü':'üå∏'}</span>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600">${esc(p.name)}${p.you?' (you)':''}</div>
          <div class="mono" style="font-size:9px;color:#50506a;display:block;margin-top:2px">${lbMode==='streak'?p.streak+' day streak':lbMode==='perfect'?p.perfect+' perfect days':Math.round(p.pct)+'% today'}</div>
          <div style="height:3px;background:#20202d;border-radius:10px;margin-top:4px;overflow:hidden">
            <div style="height:100%;width:${barPct}%;background:${lbColors[i%lbColors.length]};border-radius:10px;transition:width .5s"></div>
          </div>
        </div>
        <div class="mono" style="font-size:11px;color:#f5c842;flex-shrink:0">${score}</div>
      </div>`;
  }).join('');
}

function setLbMode(mode) { lbMode=mode; renderFriends(); }

async function addFriend() {
  const inp = document.getElementById('friendCodeInp');
  const code = inp?.value.trim().toUpperCase();
  if (!code) return;
  const uid = currentUser.id;
  const profile = LS.get('glowup_profile_' + uid)||{};
  const myCode = profile.friend_code || genCode(currentUser.email || uid);
  if (code === myCode) { toast("That's your own code! üòÑ"); return; }
  if ((S.friends||[]).includes(code)) { toast('Already added!'); return; }

  // Check this code exists in Supabase
  const { data } = await sb.from('leaderboard').select('friend_code,display_name').eq('friend_code', code).single();
  if (!data) { toast('Code not found ‚Äî your friend needs to sign up first'); return; }

  if (!S.friends) S.friends = [];
  S.friends.push(code);
  inp.value='';
  debounceSave();
  renderFriends();
  toast(`${data.display_name} added! üéâ`);
}

function copyCode(code) {
  navigator.clipboard?.writeText(code).then(()=>toast('Code copied! üîó')).catch(()=>toast('Your code: '+code));
}
function nativeShare(code, name) {
  const msg = `Hey! I'm using GlowUp to track my habits üå±\nAdd me with my code: ${code}\nSign up at [your-url] and let's keep each other accountable! üî•`;
  if (navigator.share) navigator.share({title:'Join me on GlowUp!',text:msg});
  else { navigator.clipboard?.writeText(msg); toast('Message copied ‚Äî share it! üìã'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ME PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProfileEmojiEdit() {
  const uid = currentUser?.id||'';
  const profile = LS.get('glowup_profile_'+uid)||{};
  const current = profile.emoji||'üåü';
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);z-index:400;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.innerHTML = `
    <div style="background:#14141a;border:1px solid #262636;border-radius:20px;padding:24px;width:100%;max-width:340px">
      <div class="mono" style="font-size:10px;color:#50506a;text-transform:uppercase;letter-spacing:1px;text-align:center;margin-bottom:12px">Profile Emoji</div>
      <div style="display:flex;align-items:center;gap:10px;background:#1a1a24;border:1px solid #262636;border-radius:10px;padding:10px 14px;margin-bottom:14px">
        <span id="emojiPreview" style="font-size:28px">${current}</span>
        <input id="emojiTypeInp" value="${current}" placeholder="Type any emoji‚Ä¶" maxlength="8"
          style="flex:1;background:transparent;border:none;outline:none;color:#e8e8f0;font-size:20px;font-family:'DM Sans',sans-serif"
          oninput="document.getElementById('emojiPreview').textContent=this.value||'üåü'">
      </div>
      <div class="mono" style="font-size:9px;color:#50506a;margin-bottom:10px">Or tap one:</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">
        ${['üåü','‚ú®','üå∏','üí´','ü¶ã','üå∫','üíé','üî•','üåô','‚òÄÔ∏è','üåà','üéØ','üí™','üßò','üå±','üéÄ','üåä','ü´ß','ü™∑','üåª','üíê','ü¶ö','üå¥','üçÄ','ü´∂'].map(e=>`<button onclick="document.getElementById('emojiTypeInp').value='${e}';document.getElementById('emojiPreview').textContent='${e}'" style="font-size:22px;width:40px;height:40px;border-radius:8px;background:#1a1a24;border:none;cursor:pointer">${e}</button>`).join('')}
      </div>
      <button onclick="saveProfileEmoji()" style="display:block;width:100%;padding:12px;background:#c8f564;color:#0d0d0f;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;margin-bottom:8px">Save ‚úì</button>
      <button onclick="this.closest('[style*=fixed]').remove()" style="display:block;width:100%;padding:10px;background:none;border:none;color:#50506a;font-size:14px;cursor:pointer">Cancel</button>
    </div>`;
  document.body.appendChild(overlay);
  overlay.addEventListener('click', e => { if(e.target===overlay) overlay.remove(); });
}
async function saveProfileEmoji() {
  const val = document.getElementById('emojiTypeInp')?.value?.trim()||'üåü';
  const uid = currentUser?.id||'';
  const profile = LS.get('glowup_profile_'+uid)||{};
  profile.emoji = val;
  LS.set('glowup_profile_'+uid, profile);
  await sb.from('profiles').upsert({user_id:uid, emoji:val});
  document.querySelector('[style*="position:fixed"][style*="inset:0"]:last-child')?.remove();
  renderMe();
  toast('Profile updated ‚ú®');
}

function renderMe() {
  const uid = currentUser?.id || '';
  const profile = LS.get('glowup_profile_' + uid)||{};
  const stmt = S.identity.statement||'';
  const allSubs = S.cats.flatMap(c=>c.subs);
  const done = allSubs.filter(s=>s.done).length;
  const maxStreak = Math.max(...allSubs.map(s=>s.streak||0),0);
  const doneNames = allSubs.filter(s=>s.done).map(s=>s.name);
  const displayName = profile.display_name || currentUser?.email?.split('@')[0] || 'You';
  const emailHandle = currentUser?.email || '';

  const goalsHtml = S.goals.length ? S.goals.map(g=>`
    <div style="background:#14141a;border:1px solid #262636;border-radius:12px;padding:11px;margin-bottom:8px;display:flex;align-items:center;gap:10px">
      <div style="width:8px;height:8px;border-radius:50%;background:${g.type==='short'?'#64c8f5':'#a064f5'};flex-shrink:0"></div>
      <span style="font-size:13px;font-weight:600;flex:1">${esc(g.title||'Untitled goal')}</span>
      <span class="mono" style="font-size:11px;color:#50506a">${g.pct}%</span>
    </div>`).join('') : `<div class="mono" style="font-size:11px;color:#50506a">No goals yet ‚Äî add them in Mind tab üéØ</div>`;

  document.getElementById('page-me').innerHTML = `
    <div style="padding:48px 18px 20px;text-align:center">
      <div onclick="openProfileEmojiEdit()" style="width:76px;height:76px;border-radius:50%;margin:0 auto 10px;background:linear-gradient(135deg,#c8f564,#64c8f5);display:flex;align-items:center;justify-content:center;font-size:34px;border:3px solid #1a1a24;cursor:pointer;position:relative" title="Tap to change">
        ${esc(profile.emoji||'üåü')}
        <div style="position:absolute;bottom:0;right:0;width:22px;height:22px;border-radius:50%;background:#1a1a24;border:2px solid #262636;display:flex;align-items:center;justify-content:center;font-size:10px">‚úèÔ∏è</div>
      </div>
      <div class="serif" style="font-size:22px;font-weight:700;display:block;margin-bottom:3px">${esc(displayName)}</div>
      <div class="mono" style="font-size:10px;color:#50506a;display:block;margin-bottom:4px;letter-spacing:1px">${esc(emailHandle)}</div>
      <div class="serif" style="font-size:13px;font-style:italic;color:#8888a8;display:block;max-width:280px;margin:0 auto">${stmt?`"${esc(stmt.slice(0,80))}${stmt.length>80?'‚Ä¶':''}"` : 'Fill in your identity statement ‚ú®'}</div>
    </div>
    <div class="stats-grid">
      ${[{n:done,l:'Done Today',c:'#c8f564'},{n:maxStreak,l:'Day Streak',c:'#f5c842'},{n:S.entries.length,l:'Journal Entries',c:'#f564a9'}].map(st=>`
        <div class="stat-card">
          <div class="serif" style="font-size:22px;font-weight:700;color:${st.c};display:block">${st.n}</div>
          <div class="mono" style="font-size:9px;color:#50506a;text-transform:uppercase;letter-spacing:1px;display:block;margin-top:2px">${st.l}</div>
        </div>`).join('')}
    </div>
    <div style="padding:0 14px;margin-bottom:18px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:10px">My Identity</div>
      <div class="id-snap">
        <div class="serif" style="font-size:15px;font-style:italic;line-height:1.6;color:#e8e8f0">${stmt||'Add your identity statement in the Mind tab ‚ú®'}</div>
      </div>
    </div>
    <div style="padding:0 14px;margin-bottom:18px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:10px">Active Goals</div>
      ${goalsHtml}
    </div>
    <div style="padding:0 14px;margin-bottom:20px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:10px">Today's Wins</div>
      <div style="background:#14141a;border:1px solid #262636;border-radius:12px;padding:14px">
        <div class="serif" style="font-size:14px;font-style:italic;color:${doneNames.length?'#c8f564':'#8888a8'};line-height:1.7">${doneNames.length?'Today I showed up: '+doneNames.join(' ¬∑ '):'Complete habits to see your wins here ‚ú®'}</div>
      </div>
    </div>
    <button class="btn-ghost" onclick="logout()" style="margin:0 14px 20px;width:calc(100% - 28px)">Sign Out</button>
    <div style="padding:0 14px;margin-bottom:20px">
      <div class="mono" style="font-size:10px;letter-spacing:2px;color:#50506a;text-transform:uppercase;display:block;margin-bottom:10px">Settings & Notifications</div>
      <div style="background:#14141a;border:1px solid #262636;border-radius:14px;overflow:hidden">
        <div class="s-row"><span style="font-size:18px;width:30px;text-align:center;flex-shrink:0">üåÖ</span><div style="flex:1"><div style="font-size:14px;font-weight:600">Morning summary</div><div class="mono" style="font-size:10px;color:#50506a">Daily digest notification</div></div><input type="time" class="tin" id="morningDigestInp" value="${S.morningDigestTime||'08:00'}" onchange="S.morningDigestTime=this.value;debounceSave()"></div>
        <div class="s-row"><span style="font-size:18px;width:30px;text-align:center;flex-shrink:0">üåô</span><div style="flex:1"><div style="font-size:14px;font-weight:600">Evening wind-down</div><div class="mono" style="font-size:10px;color:#50506a">Journal & review</div></div><input type="time" class="tin" value="21:00"></div>
        <div class="s-row"><span style="font-size:18px;width:30px;text-align:center;flex-shrink:0">üîî</span><div style="flex:1"><div style="font-size:14px;font-weight:600">Browser notifications</div><div class="mono" style="font-size:10px;color:#50506a" id="notifStatus">Tap to enable</div></div><label class="tog-wrap"><input type="checkbox" id="notifToggle" onchange="toggleNotif(this)"><div class="tog-track"></div><div class="tog-thumb"></div></label></div>
        <div class="s-row"><span style="font-size:18px;width:30px;text-align:center;flex-shrink:0">üîÑ</span><div style="flex:1"><div style="font-size:14px;font-weight:600">Reset today</div><div class="mono" style="font-size:10px;color:#50506a">Clear today's checkmarks</div></div><button onclick="resetToday()" style="background:none;border:1px solid #32324a;border-radius:8px;padding:5px 12px;color:#8888a8;font-family:'DM Mono',monospace;font-size:11px;cursor:pointer">Reset</button></div>
      </div>
    </div>
    <div style="margin:0 14px 20px;background:rgba(200,245,100,.04);border:1px solid rgba(200,245,100,.15);border-radius:12px;padding:14px;display:flex;gap:12px">
      <span style="font-size:21px;flex-shrink:0;margin-top:1px">üì±</span>
      <div class="mono" style="font-size:11px;color:#8888a8;line-height:1.7">
        <strong style="color:#c8f564;display:block;margin-bottom:4px;font-size:12px">Add to Home Screen</strong>
        iPhone (Safari): tap Share (‚ñ°‚Üë) ‚Üí "Add to Home Screen"<br>
        Android (Chrome): tap ‚ãÆ ‚Üí "Add to Home Screen"
      </div>
    </div>`;

  if (Notification.permission==='granted') {
    const st = document.getElementById('notifStatus');
    const cb = document.getElementById('notifToggle');
    if (st) st.textContent = 'Enabled ‚úì';
    if (cb) cb.checked = true;
  }
}

function toggleNotif(el) {
  if (el.checked && 'Notification' in window) {
    Notification.requestPermission().then(p => {
      const st = document.getElementById('notifStatus');
      if (p==='granted') { if(st) st.textContent='Enabled ‚úì'; toast('Notifications enabled üîî'); }
      else { el.checked=false; }
    });
  }
}
function resetToday() {
  S.cats = S.cats.map(c=>({...c,subs:c.subs.map(s=>({...s,done:false}))}));
  debounceSave(); renderMe(); toast('Fresh start üå±');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STARTUP ‚Äî check for existing Supabase session
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async function startup() {
  // Check if already logged in (Supabase persists sessions automatically)
  const { data: { session } } = await sb.auth.getSession();
  if (session?.user) {
    currentUser = session.user;
    await finishLogin();
  }
  // Enter key on login fields
  document.getElementById('authUser').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('authPass').focus(); });
  document.getElementById('authPass').addEventListener('keydown', e => { if(e.key==='Enter') handleAuth(); });
})();
</script>
</body>
</html>
